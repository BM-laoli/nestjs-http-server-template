# è¯´æ˜
>
> å›ç­”ä¸€äº› A&Q çš„é—®é¢˜, å¯èƒ½å­˜åœ¨åè§æˆ–é”™è¯¯ï¼Œæ¬¢è¿ğŸ‘å¤§å®¶æŒ‡å‡ºï¼ŒåŠªåŠ›æ”¹è¿› å…±åŒåŠªåŠ›ğŸ’ª

## é‡è¦çš„è·¯å¾„è¯´æ˜
>
> å‰é¢çš„æ–‡æ¡£å¾ˆå¤šæ¬¡ éƒ½æ˜¯åœ¨è¯´ä»€ä¹ˆä»€ä¹ˆè¿™ä¹ˆç”¨ï¼Œæ€ä¹ˆç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬ç°åœ¨æ¥è§¦äº†è¿™ä¹ˆå¤šçš„ ğŸ”§ å·¥å…·ï¼š Controller\ Providers\ Module \ Service \ Middleware \ Filter \ Pip \Guard \ Interceptor \ Decorator \
> å…¶ä¸­ é™¤å»å››å¥—ä»¶ï¼ŒController\ Module \ Service  \ Providers æˆ‘ä»¬å¾ˆå¥½ç†è§£ä¹‹å¤–ï¼Œå…¶å®ƒéƒ½æ˜¯å¯¹ request/ respose çš„å¢å¼ºï¼Œ é‚£ä¹ˆè¿™é‡Œå°±æœ‰ä¸€ä¸ªé—®é¢˜äº†ï¼Œå®ƒä»¬ä¹‹é—´çš„è°ƒç”¨é¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿä»€ä¹ˆäº‹æƒ…é€‚åˆç”¨è¿™ä¸ª ä»€ä¹ˆäº‹æƒ…é€‚åˆç”¨é‚£ä¸ª?
> ä»¥ä¸‹ æˆ‘ä»…ä»å®˜æ–¹å’Œ è‡ªå·±çš„ç»éªŒæ¥è°ˆè°ˆ ä¾›ä½ å‚è€ƒ

### å®˜æ–¹çš„æ–‡æ¡£ å¯¹ requestç”Ÿå‘½å‘¨æœŸåšäº†ç®€è¦è¯´æ˜

<https://docs.nestjs.com/faq/request-lifecycle>

ç”±äºNestæä¾›äº†éå¸¸å¤šçš„ res/req çš„å¢å¼ºå·¥å…·ï¼Œè€Œä¸” å®ƒä»¬å„ç§éƒ½å…·å¤‡ å…¨å±€çš„/æ¨¡å—å†…çš„ï¼Œè¿™å¯¼è‡´æˆ‘ä»¬çš„æœ€ç»ˆä¼šéå¸¸çš„å›°éš¾ï¼Œç»„åˆæ–¹å¼ä¹Ÿéå¸¸çš„å¤šã€‚æ‰€ä»¥æˆ‘ä»¬å…ˆæ¥ç®€å•çš„çœ‹çœ‹ï¼Œå®˜æ–¹ä¸ºåŸè¯æ˜¯ **ä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªè¯·æ±‚æµç»ä¸­é—´ä»¶ã€å®ˆå«ä¸æ‹¦æˆªå™¨ï¼Œç„¶ååˆ°è¾¾ç®¡é“ï¼Œå¹¶æœ€ç»ˆå›åˆ°æ‹¦æˆªå™¨ä¸­çš„è¿”å›è·¯å¾„ä¸­ï¼ˆä»è€Œäº§ç”Ÿå“åº”**

ä¸­é—´ä»· -> å®ˆå« â€”> reqæ‹¦æˆªå™¨ -> ç®¡é“ -> è¿”å›ç›¸åº” -> resæ‹¦æˆªå™¨

1. ä¸­é—´ä»¶

å…ˆçœ‹ç¬¬ä¸€ç‚¹ *ä¸­é—´ä»¶æ˜¯åœ¨è·¯ç”±å¤„ç†ç¨‹åº ä¹‹å‰ è°ƒç”¨çš„å‡½æ•°*
å¯¹äº middleware æœ‰å…¨å±€å’Œæ¨¡å—çš„ä¸¤ç§ï¼Œreqè¿›å…¥æ—¶ï¼ŒNestå…ˆä¼šè¿è¡Œå…¨å±€çš„(app.use)ï¼Œç„¶åè¿è¡Œè·¯å¾„ä¸­æŒ‡å®šçš„æ¨¡å—å†…middlewareï¼Œ reqå‡ºå»çš„æ—¶å€™ åˆ™æ˜¯å…ˆæ¨¡å—å†…çš„ç„¶åå…¨å±€çš„ã€‚

2. å®ˆå«

å¯¹äº å®ˆå«æ¥è¯´*å®ˆå«åœ¨æ¯ä¸ªä¸­é—´ä»¶ä¹‹åæ‰§è¡Œï¼Œä½†åœ¨ä»»ä½•æ‹¦æˆªå™¨æˆ–ç®¡é“ä¹‹å‰æ‰§è¡Œã€‚* å…¨å±€å®ˆå« -> æ§åˆ¶å™¨å®ˆå« -> æœ€åæ˜¯è·¯å¾„å®ˆå« ï¼Œè‹¥å¤šä¸ªå®ˆå«åˆ™æ˜¯æŒ‰é¡ºåºæ‰§è¡Œ

```ts
app.useGlobalGuard(new Guard0())
++++
@UseGuards(Guard1, Guard2)
@Controller('cats')
export class CatsController {
  constructor(private catsService: CatsService) {}

  @UseGuards(Guard3)
  @Get()
  getCats(): Cats[] {
    return this.catsService.getCats();
  }
}

// è¿™ç§æƒ…å†µä¸‹ Guard0 -> Guard1 -> Guard2 -> Guard3 å½“ç„¶äº†å¦‚æœæœ‰å…¨å±€çš„ å°±ä¼šå…ˆæ‰§è¡Œå…¨å±€çš„ ï¼ˆapp.useGlobalGuard()ï¼‰
```

3. æ‹¦æˆªå™¨ï¼ˆè¯·æ±‚å‰  next.handle() ä¹‹å‰

å¤§éƒ¨åˆ†æƒ…å†µä¸‹ç±»å‹ï¼Œä½†æ˜¯æœ‰ä¸€ç§æƒ…å†µç‰¹æ®Š å°±æ˜¯ è¿”å›rxjs Observables æ—¶å°±æ˜¯*å…ˆè¿›åå‡ºäº†*  æˆ–è€… req/res åœ¨erroræ—¶ éƒ½èƒ½å¤Ÿè¢« æ‹¦æˆªå™¨ *catchError* è¯»å–åˆ°ã€‚

ä¹Ÿå°±æ˜¯ next.handle() ä¹‹å‰ ä¼šç»‘å®šéƒ¨åˆ†é€»è¾‘ ç„¶åè¿›å…¥ä¸‹é¢çš„å¤„ç†ä¸­

4. ç®¡é“

ç®¡é“æŒ‰ç…§æ ‡å‡†çš„ä»å…¨å±€åˆ°æ§åˆ¶å™¨å†åˆ°è·¯ç”±çš„ç»‘å®šé¡ºåºï¼Œéµå¾ªå…ˆè¿›å…ˆå‡ºçš„åŸåˆ™æŒ‰ç…§@usePipes()å‚æ•°æ¬¡åºé¡ºåºæ‰§è¡Œ, ä½†æœ‰ä¸€ä¸ªæƒ…å†µç‰¹æ®Š *è·¯ç”±å‚æ•°å±‚ å¤šä¸ªç®¡é“æ‰§è¡Œï¼Œä»åå‘å‰*

```ts
@UsePipes(GeneralValidationPipe)
@Controller('cats')
export class CatsController {
  constructor(private catsService: CatsService) {}

  @UsePipes(RouteSpecificPipe)
  @Patch(':id')
  updateCat(
    @Body() body: UpdateCatDTO,
    @Param() params: UpdateCatParams,
    @Query() query: UpdateCatQuery,
  ) {
    return this.catsService.updateCat(body, params, query);
  }
}

// GeneralValidationPipe å…ˆæ‰§è¡Œqueryç„¶åæ˜¯params > body
// ç„¶åæ˜¯  RouteSpecificPipeçš„ RouteSpecificPipe
```

5. æ‰§è¡Œå…·ä½“çš„controller æ–¹æ³•

6. å›åˆ° æ‹¦æˆªå™¨ä¸­ ï¼ˆè¯·æ±‚ä¹‹å next.handle() ä¹‹åï¼‰

7. è¿‡æ»¤å™¨ å‰é¢çš„æ‰€æœ‰æµç¨‹ä¸­çš„å¼‚å¸¸ ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œcatchåˆ°

è¿™ä¸ªä¸œè¥¿ æ¯”è¾ƒç‰¹æ®Š *è€Œæ˜¯ä¼šä»æœ€ä½å±‚æ¬¡å¼€å§‹å¤„ç†* å…ˆ å…·ä½“çš„router > contoller > å…¨å±€ï¼Œ
ä¸” **å¼‚å¸¸æ— æ³•ä»è¿‡æ»¤å™¨ä¼ é€’åˆ°å¦ä¸€ä¸ªè¿‡æ»¤å™¨**

**å¦‚æœä¸€ä¸ªè·¯ç”±å±‚è¿‡æ»¤å™¨æ•æ‰åˆ°ä¸€ä¸ªå¼‚å¸¸ï¼Œä¸€ä¸ªæ§åˆ¶å™¨æˆ–è€…å…¨å±€å±‚é¢çš„è¿‡æ»¤å™¨å°±æ•æ‰ä¸åˆ°è¿™ä¸ªå¼‚å¸¸ã€‚å¦‚æœè¦å®ç°ç±»ä¼¼çš„æ•ˆæœå¯ä»¥åœ¨è¿‡æ»¤å™¨ä¹‹é—´ä½¿ç”¨ç»§æ‰¿ã€‚**

### æ€»ç»“ä¸€ä¸‹ å°±æ˜¯ä¸‹é¢çš„é¡ºåº

1. æ”¶åˆ°è¯·æ±‚
2. å…¨å±€ç»‘å®šçš„ä¸­é—´ä»¶
3. æ¨¡å—ç»‘å®šçš„ä¸­é—´ä»¶
4. å…¨å±€å®ˆå«
5. æ§åˆ¶å±‚å®ˆå«
6. è·¯ç”±å®ˆå«
7. å…¨å±€æ‹¦æˆªå™¨ï¼ˆæ§åˆ¶å™¨ä¹‹å‰ï¼‰
8. æ§åˆ¶å™¨å±‚æ‹¦æˆªå™¨ ï¼ˆæ§åˆ¶å™¨ä¹‹å‰ï¼‰
9. è·¯ç”±æ‹¦æˆªå™¨ ï¼ˆæ§åˆ¶å™¨ä¹‹å‰ï¼‰
10. å…¨å±€ç®¡é“
11. æ§åˆ¶å™¨ç®¡é“
12. è·¯ç”±ç®¡é“
13. è·¯ç”±å‚æ•°ç®¡é“
14. æ§åˆ¶å™¨ï¼ˆæ–¹æ³•å¤„ç†å™¨ï¼‰ 15ã€‚æœåŠ¡ï¼ˆå¦‚æœæœ‰ï¼‰
16. è·¯ç”±æ‹¦æˆªå™¨ï¼ˆè¯·æ±‚ä¹‹åï¼‰
17. æ§åˆ¶å™¨æ‹¦æˆªå™¨ ï¼ˆè¯·æ±‚ä¹‹åï¼‰
18. å…¨å±€æ‹¦æˆªå™¨ ï¼ˆè¯·æ±‚ä¹‹åï¼‰
19. å¼‚å¸¸è¿‡æ»¤å™¨ ï¼ˆè·¯ç”±ï¼Œä¹‹åæ˜¯æ§åˆ¶å™¨ï¼Œä¹‹åæ˜¯å…¨å±€ï¼‰
29. æœåŠ¡å™¨å“åº”

### æœ‰çš„åŒå­¦ å¯¹ æ‹¦æˆªå™¨çš„ next.handle() å…ˆå’Œåæœ‰ç–‘é—®
>
> æœ‰çš„åŒå­¦ å¯¹ æ‹¦æˆªå™¨çš„ next.handle() å…ˆå’Œåæœ‰ç–‘é—® ,æˆ‘ä»¬ç”¨ä¸€ä¸ªå…·ä½“çš„ä¾‹å­æ¥è¯´æ¥è¯´æ˜ï¼Œ

```ts
@Injectable()
export class LoggingInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    console.log('Before...');

    const now = Date.now();
    return next
      .handle()
      .pipe(tap(() => console.log(`After... ${Date.now() - now}ms`)));
  }
}

@Controller('cats')
@UseGuards(RolesGuard)
@UseInterceptors(LoggingInterceptor)
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get()
  @UseGuards(RolesGuard3)
  getHello(): string {
    console.log('getHello');
    return this.appService.getHello();
  }
}

// é‚£ä¹ˆä½ å°†ä¼šçœ‹åˆ°è¿™æ ·çš„log ä¿¡æ¯
Before...
getHello
After... 3ms
```

## å…³äºerror å †æ ˆå®šä½çš„é—®é¢˜
>
> è®¸å¤šåŒå­¦éƒ½æåˆ°ä¸€ä¸ªé—®é¢˜ **winston æ‰“å°çš„å †æ ˆä¿¡æ¯æ€ä¹ˆå®šä½åˆ°æºç ä½ç½®ï¼Œæˆ‘è°ƒè¯•å‡ºæ¥æ€»æ˜¯å®šä½åˆ°ç¼–è¯‘åçš„æ–‡ä»¶ä½ç½®**

1. æˆ‘ä»¬å…ˆä¸çœ‹ä½¿ç”¨ä½•ç§ logè®°å½•å™¨ï¼Œæˆ‘ä»¬å°±å•çº¯çš„æ¥çœ‹ â€œå¦‚ä½•å®šä½ä¸ºtsæºä»£ç â€

æˆ‘ä»¬å…ˆé€ ä¸€ä¸ªerror, æœ‰ä¸€ç‚¹éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼Œæˆ‘ä»¬run å¹¶ä¸æ˜¯ç›´æ¥run tsï¼Œè€Œæ˜¯ç¼–è¯‘ä¹‹åçš„js ï¼Œæ•…ä¸€èˆ¬error çš„ å †æ ˆä¿¡æ¯ éƒ½æ˜¯åœ¨ç¼–è¯‘åçš„jsä¸­

```shell
yarn build

node ./dist main.js
```

nestjs ç¼–è¯‘å‡ºæ¥ä¹‹å å®é™…ä¸Šæ˜¯é»˜è®¤ç”Ÿäº§ sourcemapçš„ï¼Œé‚£ä¹ˆè¿™å°±å¥½åŠäº† ï¼Œnode12 ä¹‹åæœ‰ä¸€ä¸ªå‘½ä»¤ï¼Œå¯ä»¥è§£æè¿™äº›ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦  

```shell
 node --enable-source-maps ./dist/main.js
```

2. logè®°å½•å™¨ åŒæ ·å¯ä»¥è®°å½•åˆ°

## æ·±å…¥ä¸€ä¸‹ è‡ªå®šä¹‰çš„ è£…é¥°å™¨
>
> ä¸€èˆ¬å’Œæ‹¦æˆªå™¨/ä¸­é—´ä»· ç»“åˆèµ·æ¥ä½¿ç”¨

# ä¸å…¶å®ƒçš„æŠ€æœ¯è¿›è¡Œé›†æˆ
>
> ä¸å…¶å®ƒçš„æŠ€æœ¯è¿›è¡Œé›†æˆ , æ¯”å¦‚æ•°æ®åº“ã€é…ç½®ã€éªŒè¯ã€é«˜æ•°ç¼“å­˜ã€åºåˆ—åŒ–ã€Jobã€logã€cookieã€äº‹ä»¶ã€æ–‡ä»¶ä¸Šä¼ .....

## æ•°æ®åº“é›†æˆ( Mysql + Mongo )
>
> ç”±äºå‰é¢çš„ ä¸€æœŸ å·²ç»ç®€çº¦çš„è¯´æ˜äº† è¿™é‡Œå°±ä¸å†å¦å†™äº†ï¼Œæˆ‘ä»¬åªè¡¥å……æ²¡æœ‰è¯´æ˜çš„åœ°æ–¹

### Mysql
>
> mysql ç›¸å…³çš„å†…å®¹ æˆ‘å†ä»¥å‰ä¸€æœŸçš„æ–‡ç« æœ‰è¯¦ç»†çš„è¯´æ˜ï¼Œè¯·ç§»æ­¥åˆ°è¿™é‡Œ <a>ä¸€æœŸæ–‡ç« </a>

### MongoDB
>
> ä»é›¶å¼€å§‹ é›†æˆ

ä¸€äº›åŸºç¡€çš„mongodb æŠ€æœ¯ï¼Œæˆ‘ä¹‹å‰çš„æ–‡ç« ä¹Ÿæœ‰è¯¦ç»†çš„æåˆ°ï¼Œè¯·å‚è§ <a href="https://juejin.cn/post/7104641797514592293">Nodejs + MongoDB </a>

1. ä½¿ç”¨ docker éƒ¨ç½² mongodb <a href="https://hub.docker.com/_/mongo/">Mongo</a>

```shell
$ docker pull mongo
$ docker run -itd --name mongo -p 27017:27017 mongo --auth
$ docker exec -it mongo
# è¿›å…¥è¿™ä¸ª å®¹å™¨ é‡Œé¢
$  mongosh 
# æ³¨æ„æ˜¯mongosh ä¸å†æ˜¯mongo  https://www.mongodb.com/docs/manual/release-notes/6.0-compatibility/#legacy-mongo-shell-removed

# åˆ›å»ºä¸€ä¸ªåä¸º adminï¼Œå¯†ç ä¸º 123456 çš„ç”¨æˆ·ã€‚
> db.createUser({ user:'admin',pwd:'123456',roles:[ { role:'userAdminAnyDatabase', db: 'admin'},"readWriteAnyDatabase"]});
# å°è¯•ä½¿ç”¨ä¸Šé¢åˆ›å»ºçš„ç”¨æˆ·ä¿¡æ¯è¿›è¡Œè¿æ¥ã€‚
> db.auth('admin', '123456')

```

2. å¼€å§‹é›†æˆ

å…ˆæ¥å®‰è£…å¿…è¦çš„ä¾èµ–

```shell
yarn add  @nestjs/mongoose mongoose
```

å»ºç«‹è¿æ¥

```ts
// æˆ‘è‡ªå·±æ–°å»ºäº†ä¸€ä¸ª core module æ ¸å¿ƒçš„åŠŸèƒ½é€»è¾‘éƒ½å¯ä»¥ä¸¢è¿™é‡Œæ¥
import { Module } from '@nestjs/common';
import { MongooseModule } from '@nestjs/mongoose';
@Module({
  imports: [
    MongooseModule.forRoot('mongodb://admin:123456@127.0.0.1:27017/testDB', {
      useUnifiedTopology: true,
      useNewUrlParser: true,
      authSource: 'admin',
    }),
  ],
  controllers: [], 
  providers: [],
})
export class CoreModule {}

```

åˆ›å»ºæ¨¡å‹

```ts
// å»ºè®®æ–‡ä»¶å¤¹æ”¾åˆ° module ç›¸å…³æ€§çš„æ–‡ä»¶å¤¹ä¸‹
import { Prop, Schema, SchemaFactory, raw } from '@nestjs/mongoose';
import { Document } from 'mongoose';

// å£°æ˜ document ç±»å‹
export type CatDocument = Cat & Document;

// å®šä¹‰ è¿™ä¸ªschema class
// @Schema()  å½“ç„¶ä½ å¯ä»¥ä½¿ç”¨ DefinitionsFactory æ¥ç”Ÿäº§ä¸€ä¸ªæ›´åŸå§‹çš„ schema

// @Schema ä¼šæŠŠ cat æ˜ å°„åˆ° åŒåçš„ cat å¤æ•° Collection ä¸­å»
// æ³¨æ„è¿™ä¸ª @Schema  å¯ä»¥æ¥å—æ›´å¤šçš„å‚æ•° ï¼ˆhttps://mongoosejs.com/docs/guide.html#optionsï¼‰
@Schema({
  autoIndex: true,
})
export class Cat extends Document {
  // @Props éå¸¸å¼ºå¤§ ä¸ä»…å¯ä»¥ å®šä¹‰ç±»å‹ ä¹Ÿå¯ä»¥å®šä¹‰éªŒè¯è§„åˆ™ï¼Œè¯¦ç»†ç¨³å®š  https://mongoosejs.com/docs/schematypes.html
  @Prop()
  name: string;

  @Prop()
  age: number;

  @Prop()
  breed: string;

  @Prop([String])
  tags: string[];

  @Prop({ required: true })
  sex: string;

  @Prop(
    raw({
      firstName: { type: String },
      lastName: { type: String },
    }),
  )
  details: Record<string, any>;
}

export const CatSchema = SchemaFactory.createForClass(Cat);

// å¦‚æœä¸ä¹ æƒ¯ä½¿ç”¨è£…é¥°å™¨ å¯ä»¥ ç›´æ¥ monogose
// import * as mongoose from 'mongoose';
// export const CatSchema = new mongoose.Schema({
//   name: String,
//   age: Number,
//   breed: String,
// });

```

ç‰¹åˆ«æé†’ ä½ find æˆ–è€… exec ä¸‹æ¥éƒ½æ˜¯ ä¸€ä¸ªmodel ç±»å‹æ¥è‡ªmongooseï¼Œ ç”¨å®ƒå¯ä»¥å®Œæˆå„ç§å…³è”æˆ–è€…èšåˆæŸ¥è¯¢, è¿™é‡Œä¸å¤šè¯´äº† è¯¦è§æˆ‘çš„å¦ä¸€æ–‡ç«  (<https://juejin.cn/post/7104641797514592293>)

ä½¿ç”¨

```ts
// module
import { Module } from '@nestjs/common';
import { MongooseModule } from '@nestjs/mongoose';

import { CatController } from './cat.controller';
import { CatService } from './cat.service';
import { Cat, CatSchema } from './schemas/cat.schema';

@Module({
  imports: [
    MongooseModule.forFeature(
      [
        {
          name: Cat.name,
          schema: CatSchema,
        },
      ],
    ),
  ],
  controllers: [CatController],
  providers: [CatService],
})
export class CatModule {}


// service
import { Injectable } from '@nestjs/common';
import { InjectConnection, InjectModel } from '@nestjs/mongoose';
import { Connection, Model } from 'mongoose';
import { Cat, CatDocument } from './schemas/cat.schema';

@Injectable()
export class CatService {
  // æ³¨å…¥model / è¿æ¥æ± ï¼ˆåè€…çš„åŠŸèƒ½è¦æ›´å¼ºå¤§ (https://mongoosejs.com/docs/api/connection.html#Connection())
  constructor(
    @InjectModel('Cat') private catModel: Model<CatDocument>,
    @InjectConnection() private connection: Connection,
  ) {}

  getHello(): string {
    return 'Hello World!';
  }

  async create(data: any): Promise<Cat> {
    const createCat = new this.catModel(data);
    return createCat.save();
  }
}

@Controller('cat')
export class CatController {
  constructor(private readonly catService: CatService) {}

  @Post('create')
  create(@Body() body: any) {
    return this.catService.create(body);
  }
}

```

å…¶ä»–çš„é«˜çº§æ“ä½œ

```ts
// å¦‚æœéœ€è¦ å¤šæ•°æ®åº“è¿æ¥è¯·ä½¿ç”¨
// core
  imports: [
    MongooseModule.forRoot('mongodb://admin:123456@127.0.0.1:27017/testDB', {
      useUnifiedTopology: true,
      useNewUrlParser: true,
      authSource: 'admin',
      connectionName: 'testDB',
    }),
    MongooseModule.forRoot('mongodb://admin:123456@127.0.0.1:27017/testDB2', {
      useUnifiedTopology: true,
      useNewUrlParser: true,
      authSource: 'admin',
      connectionName: 'testDB2',
    }),
  ],

// module
imports: [
    MongooseModule.forFeature(
      [
        {
          name: Cat.name,
          schema: CatSchema,
        },
      ],
      'testDB',
    ),
    MongooseModule.forFeature(
      [
        {
          name: Cat.name,
          schema: CatSchema,
        },
      ],
      'testDB2',
    ),
  ],

  // service
  @Injectable()
export class CatService {
  constructor(
    @InjectModel('Cat', 'testDB2') private catModel: Model<CatDocument>,
  ) {}

  getHello(): string {
    return 'Hello World!';
  }

  async create(data: any): Promise<Cat> {
    const createCat = new this.catModel(data);
    return createCat.save();
  }
}

```

mongoDB ä¸­é—´ä»¶ å’Œ plugin çš„ä½¿ç”¨

```ts
// é—´ä»¶æ˜¯é’ˆå¯¹Schemaå±‚çº§çš„ ï¼ˆhttps://mongoosejs.com/docs/middleware.htmlï¼‰

 MongooseModule.forFeatureAsync([
      {
        name: 'Cat',
        useFactory: () => {
          const schema = CatsSchema;
          // äº†è§£ mongoose çš„æœ‹å‹éƒ½çŸ¥é“ è¿™ä¸ªåŸºæœ¬ä¸Šå°±ä¸Šmongoose çš„åŸºæ“
          schema.pre('save', () => console.log('Hello from pre save'));
          return schema;
        },
      },
    ]),

// ç±»ä¼¼çš„ plugin ä¹Ÿæ˜¯å¦‚æ­¤ https://mongoosejs.com/docs/plugins.html

// core 
// è¦å‘æ‰€æœ‰ schema ä¸­ç«‹å³æ³¨å†Œä¸€ä¸ªæ’ä»¶ï¼Œè°ƒç”¨Connectionå¯¹è±¡ä¸­çš„.plugin()æ–¹æ³•ã€‚ä½ å¯ä»¥åœ¨æ‰€æœ‰æ¨¡å‹åˆ›å»ºå‰è®¿é—®è¿æ¥ã€‚ä½¿ç”¨connectionFactoryæ¥å®ç°ï¼š
MongooseModule.forRoot('mongodb://localhost/test', {
      connectionFactory: (connection) => {
        connection.plugin(require('mongoose-autopopulate'));
        return connection;
      },
    }),

// module
// ä»…å¯¹ æŸä¸ªscheme
   MongooseModule.forFeatureAsync([
      {
        name: 'Cat',
        useFactory: () => {
          const schema = CatsSchema;
          schema.plugin(require('mongoose-autopopulate'));
          return schema;
        },
      },
    ]),
  ],
```

å¯¹äºæµ‹è¯•ï¼ˆå•å…ƒæµ‹è¯•ä»€ä¹ˆçš„
**ä¸€èˆ¬è€Œè¨€æˆ‘ä»¬é€šå¸¸å¸Œæœ›é¿å…ä»»ä½•æ•°æ®åº“è¿æ¥**

è§£å†³æ–¹æ¡ˆæ˜¯åˆ›å»ºæ¨¡æ‹Ÿmodel

```ts
@Module({
  providers: [
    CatsService,
    {
      provide: getModelToken('Cat'), // getModelToken @nestjs/mongoose å®ƒè¿”å›ä¸€ä¸ª ç¡¬ç¼–ç  å®ä¾‹å¯¹è±¡
      useValue: catModel,
    },
  ],
})
export class CatsModule {}

```

å¯¹äºæ•°æ®çš„å…³è”æ“ä½œï¼Œè¯·ç›´æ¥å‚è€ƒ <a href="https://juejin.cn/post/7104641797514592293">è¿™é‡Œ</a> ç¨³å®š

## é…ç½®
>
> ä¸€æœŸæœ‰è¯¦ç»†çš„æè¿° ä¸åšè¿‡å¤šèµ˜è¿°

## éªŒè¯
>
> æˆ‘ä»¬è®²ä¸€ä¸‹ç»†èŠ‚é—®é¢˜ å®é™…ä¸Š æˆ‘ä»¬çš„ validation å’Œ pipç´§å¯†ç›¸å…³ï¼Œä¸ä»…ä»…æ˜¯ éªŒè¯è¿˜å¯ä»¥åšè½¬æ¢

Nest ä¼šå†…ç½® 9 ä¸ªå¼€ç®±å³ç”¨ çš„pip,å®ƒä»¬åˆ†ä¸¤ç±»

- ValidationPipe
- DefaultValuePipe
- ParseIntPipe
- ParseFloatPipe
- ParseBoolPipe
- ParseArrayPipe
- ParseUUIDPipe
- ParseEnumPipe
- ParseFilePipe

### Parse* ç±»å‹çš„Pip
>
> è¿™é‡Œçš„éƒ½æ˜¯ Parse å¼€å¤´çš„ pip ä¸»è¦ç”¨æ¥éªŒè¯ å€¼æ˜¯å¦åˆæ³•, ä½¿ç”¨éå¸¸çš„ç®€å•

```ts
import {
  Controller,
  Get,
  HttpStatus,
  Param,
  ParseIntPipe,
  Query,
} from '@nestjs/common';
@Controller('pip')
export class PipController {
  @Get('t1/:id')
  test1(@Param('id', ParseIntPipe) id: number) {
    // å‚æ•°çº§åˆ«ç»‘å®š
    return 't1';
  }

  @Get('t2/:id')
  test2(
    @Param(
      'id',
      new ParseIntPipe({ errorHttpStatusCode: HttpStatus.NOT_ACCEPTABLE }),
    )
    id: number,
  ) {
    // ä½¿ç”¨å®ä¾‹ è€Œä¸æ˜¯class classä¼šåœ¨ioc å®¹å™¨å†…éƒ¨å¤„ç†æ‰
    return 't2';
  }

  @Get('t3')
  test3(@Query('id', ParseIntPipe) id: number) {
    return 'te';
  }
}
```

### Validationç±»å‹çš„Pip
>
> å®é™…ä¸Šä¸Šè¿°çš„ 9ä¸ª åªæœ‰ä¸¤ä¸ªæ˜¯ç‰¹ä¾‹ ValidationPipe + DefaultValuePipe

è¦ä½¿ç”¨ nestå†…ç½®çš„ ValidationPipe éœ€è¦install ä¸¤ä¸ªä¾èµ–, å®ƒçš„åŠŸèƒ½éå¸¸çš„å¼ºå¤§

```shell
yarn add class-validator class-transformer
```

æœ€å¸¸è§çš„ä½¿ç”¨æ–¹å¼ å…¨å±€è‡ªåŠ¨åŠ ä¸Š ValidationPipeï¼Œç„¶åç»“åˆ class-validator æä¾›çš„è£…é¥°å™¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥éå¸¸å¿«æ·çš„å†™å‡º å¼ºå¤§ä¸”åˆé€‚çš„ pip

new ValidationPipe æœ‰è®¸å¤šå¯é€‰å‚æ•°
|name|types|des|
|------|------|-----|
| enableDebugMessages | boolean | å¦‚æœè®¾ç½®ä¸º true ï¼ŒéªŒè¯å™¨ä¼šåœ¨å‡ºé—®é¢˜çš„æ—¶å€™æ‰“å°é¢å¤–çš„è­¦å‘Šä¿¡æ¯ |
| skipUndefinedProperties | boolean | å¦‚æœè®¾ç½®ä¸º true ï¼ŒéªŒè¯å™¨å°†è·³è¿‡å¯¹æ‰€æœ‰éªŒè¯å¯¹è±¡ä¸­å€¼ä¸º null çš„å±æ€§çš„éªŒè¯ |
| skipNullProperties | boolean | å¦‚æœè®¾ç½®ä¸º true ï¼ŒéªŒè¯å™¨å°†è·³è¿‡å¯¹æ‰€æœ‰éªŒè¯å¯¹è±¡ä¸­å€¼ä¸º null æˆ– undefined çš„å±æ€§çš„éªŒè¯ |
| skipMissingProperties | boolean | å¦‚æœè®¾ç½®ä¸º true ï¼ŒéªŒè¯å™¨å°†è·³è¿‡å¯¹æ‰€æœ‰éªŒè¯å¯¹è±¡ä¸­ç¼ºå¤±çš„å±æ€§çš„éªŒè¯ |
| whitelist | boolean | å¦‚æœè®¾ç½®ä¸º true ï¼ŒéªŒè¯å™¨å°†å»æ‰æ²¡æœ‰ä½¿ç”¨ä»»ä½•éªŒè¯è£…é¥°å™¨çš„å±æ€§çš„éªŒè¯ï¼ˆè¿”å›çš„ï¼‰å¯¹è±¡ |
| forbidNonWhitelisted | boolean | å¦‚æœè®¾ç½®ä¸º true ï¼ŒéªŒè¯å™¨ä¸ä¼šå»æ‰éç™½åå•çš„å±æ€§ï¼Œè€Œæ˜¯ä¼šæŠ›å‡ºå¼‚å¸¸ |
| forbidUnknownValues | boolean | å¦‚æœè®¾ç½®ä¸º true ï¼Œå°è¯•éªŒè¯æœªçŸ¥å¯¹è±¡ä¼šç«‹å³å¤±è´¥ |
| disableErrorMessage | boolean | å¦‚æœè®¾ç½®ä¸º true ,éªŒè¯é”™è¯¯ä¸ä¼šè¿”å›ç»™å®¢æˆ·ç«¯ |
| errorHttpStatusCode | number | è¿™ä¸ªè®¾ç½®å…è®¸ä½ ç¡®å®šåœ¨é”™è¯¯æ—¶ä½¿ç”¨å“ªä¸ªå¼‚å¸¸ç±»å‹ã€‚é»˜è®¤æŠ›å‡º BadRequestException |
| exceptionFactory | Function | æ¥å—ä¸€ä¸ªéªŒè¯é”™è¯¯æ•°ç»„å¹¶è¿”å›ä¸€ä¸ªè¦æŠ›å‡ºçš„å¼‚å¸¸å¯¹è±¡ |
| groups | string[] | éªŒè¯å¯¹è±¡æ—¶ä½¿ç”¨çš„åˆ†ç»„ |
| always | boolean | è®¾ç½®è£…é¥°å™¨é€‰é¡¹ always çš„é»˜è®¤å€¼ã€‚é»˜è®¤å€¼å¯ä»¥åœ¨è£…é¥°å™¨çš„é€‰é¡¹ä¸­è¢«è¦†å†™ |
| strictGroups | boolean | å¿½ç•¥åœ¨ä»»ä½•åˆ†ç»„å†…çš„è£…é¥°å™¨ï¼Œå¦‚æœ groups æ²¡æœ‰ç»™å‡ºæˆ–è€…ä¸ºç©º |
| dismissDefaultMessages | boolean | å¦‚æœè®¾ç½®ä¸º true ï¼Œå°†ä¸ä¼šä½¿ç”¨é»˜è®¤æ¶ˆæ¯éªŒè¯ï¼Œå¦‚æœä¸è®¾ç½®ï¼Œé”™è¯¯æ¶ˆæ¯ä¼šå§‹ç»ˆæ˜¯ undefined |
| validationError.target | boolean | ç¡®å®šç›®æ ‡æ˜¯å¦è¦åœ¨ ValidationError ä¸­æš´éœ²å‡ºæ¥ |
| validationError.value | boolean | ç¡®å®šéªŒè¯å€¼æ˜¯å¦è¦åœ¨ ValidationError ä¸­æš´éœ²å‡ºæ¥ |
| stopAtFirstError | boolean | å¦‚æœè®¾ç½®ä¸º true ï¼Œå¯¹äºç»™å®šçš„å±æ€§çš„éªŒè¯ä¼šåœ¨è§¦å‘ç¬¬ä¸€ä¸ªé”™è¯¯ä¹‹ååœæ­¢ã€‚é»˜è®¤ä¸º false |

1. ç®€å•å®ç”¨

```ts
// å½“ç„¶æˆ‘ä»¬å¯ä»¥å…¨å±€å¼€ ä¹Ÿå¯ä»¥ å±€é™äº controller / å…·ä½“é¢è·¯ç”±ä¸Š
app.useGlobalPipes(new ValidationPipe());

// ä¾‹å­ğŸŒ° 
@Post()
@UsePipes(new ValidationPipe())
async create(@Body() createCatDto: CreateCatDto) {
  this.catsService.create(createCatDto);
}

// æ–°å»ºDTO
import { IsEmail, IsNotEmpty } from 'class-validator';

export class TestDto {
  @IsEmail()
  email: string;

  @IsNotEmpty()
  password: string;
}

// æ³¨æ„ä¸è¦åˆ°å¤„ type TestDto
// tsç±»å‹ä¼šåœ¨è¿è¡Œæ—¶è¢«æ“¦é™¤ï¼Œè®°å¾—ç”¨ import { CreateUserDto } è€Œä¸æ˜¯ import type { CreateUserDto }

// ä½¿ç”¨DTO
  @Post('t4')
  test4(@Body() testDto: TestDto) {
    return 't4';
  }

```

2. æ§åˆ¶ç™½åå•

```ts

// å¦‚æœä½ éœ€è¦ä½¿ç”¨ç™½åå• å¯ä»¥è¿™æ ·æ“ä½œ
app.useGlobalPipes(
  new ValidationPipe({
    whitelist: true,
    // forbidNonWhitelisted:true è‹¥ä½ å¸Œæœ› é‡åˆ°ç™½åå•çš„æ—¶å€™ è¿”å›é”™è¯¯ è¯·å¼€å¯å®ƒ
  })
);

// åœ¨DTO ä¸­ä¸åŠ ä»»ä½• è£…é¥°çš„ å°±æ˜¯ç™½åå•çš„å­—æ®µ
export class TestDto {
  @IsEmail()
  email: string;

  @IsNotEmpty()
  password: string;

  name: string
}

```

3. è¿›è¡Œè½¬æ¢

> æ³¨æ„ paser* å¼€å¤´çš„ä¼šè‡ªåŠ¨è½¬åŒ–

```ts
findOne(
  @Param('id', ParseIntPipe) id: number,
  @Query('sort', ParseBoolPipe) sort: boolean,
) {
  console.log(typeof id === 'number'); // true
  console.log(typeof sort === 'boolean'); // true
  return 'This action returns a user';
}

// æˆ‘ä»¬ç»å¸¸æœ‰è¿™æ ·çš„éœ€æ±‚ï¼šcreate çš„æ—¶å€™å¸Œæœ›ä¼ é€’å…¨éƒ¨ï¼Œmodifyçš„æ—¶å€™éœ€è¦å¤šä¼ ä¸€ä¸ª idï¼Œæœ‰æ²¡æœ‰åŠæ³•æ–¹ä¾¿çš„å®ç°å‘¢ï¼Ÿæˆ–è€…ä¿®æ”¹çš„æ—¶å€™æŸä¸ªå­—æ®µåˆå˜æˆå¯é€‰çš„äº†

// Nest æä¾›äº† PartialType() å‡½æ•°æ¥è®©è¿™ä¸ªä»»åŠ¡å˜å¾—ç®€å•
export class CreateCatDto {
  name: string;
  age: number;
  breed: string;
}

// PartialType() å‡½æ•°æ˜¯ä» @nestjs/mapped-types ä¸‹é¢çš„ä¾‹å­ æ‰€æœ‰çš„å‚æ•°éƒ½æ˜¯å¯é€‰çš„
export class UpdateCatDto extends PartialType(CreateCatDto) {}

// å¦‚æœä½ å¯¹ ts ç†Ÿæ‚‰çš„è¯ï¼ŒPickTã€Omit...... æˆ‘å°±ä¸å¤šä»‹ç»äº†è¯·çœ‹ä¸‹é¢çš„ä»£ç 
export class CreateCatDto {
  name: string;
  breed: string;
}
export class AdditionalCatInfo {
  color: string;
}
export class UpdateCatDto extends IntersectionType(
  CreateCatDto,
  AdditionalCatInfo,
) {}

// è‹¥è¦éªŒè¯Array ä¸‹é¢è¿™ç§äº‹ä¸è¡Œçš„ è¯·ä½¿ç”¨
@Post()
createBulk(@Body() createUserDtos: CreateUserDto[]) {
  return 'This action adds new users';
}

@Post()
createBulk(
  @Body(new ParseArrayPipe({ items: CreateUserDto }))
  createUserDtos: CreateUserDto[],
) {
  return 'This action adds new users';
}

// å¦‚æœä½ éœ€è¦æ‰‹åŠ¨å¤„ç† array æ¯”å¦‚ GET /?ids=1,2,3
@Get()
findByIds(
  @Query('id', new ParseArrayPipe({ items: Number, separator: ',' }))
  ids: number[],
) {
  return 'This action returns users by ids';
}


// æ›´å¤šçš„ è¯·çœ‹å®˜æ–¹æ–‡æ¡£ https://docs.nestjs.com/techniques/validation



```

### è‡ªå®šä¹‰Pip
>
> å®é™…ä¸Šçš„ ä¹Ÿå°±æ˜¯ ä¸€ä¸ª åŠŸèƒ½å¯è‡ªå®šä¹‰çš„ validation

```ts
import { PipeTransform, Injectable, ArgumentMetadata } from '@nestjs/common';
// import { ValidationPipe } from '@nestjs/common';

@Injectable()
export class MyValidationPipe implements PipeTransform {
  // å¿…é¡»è¦å®ç°çš„ä¸€ä¸ªæ–¹æ³•
  transform(value: any, metadata: ArgumentMetadata) {
    // è¿™é‡Œå¯ä»¥è¿›è¡Œè½¬åŒ– / threw error

    // Value å°±ç®—è¾“å…¥çš„value
    // metadata æ˜¯æ‰€è°“çš„ å…ƒæ•°æ® ã€‚æ¯”å¦‚string isRequired è¿™ç§

    // å…·ä½“çš„å®ç° å¯ä»¥å‚è€ƒ ValidationPipe çš„æºç å®ç°
    return value;
  }
}

```

## ç¼“å­˜é—®é¢˜
>
> Nest æä¾›äº†ä¸€ä¸ª éå¸¸å¿«æ· ä¸”ä¸éœ€è¦ å…¶å®ƒåŸºç¡€è®¾æ–½(redis ä¹‹ç±»çš„ ç¼“å­˜å·¥å…·)

æ³¨æ„ å†å²ç‰ˆæœ¬é—®é¢˜  v5 çš„ cache-manager ä½¿ç”¨ æ¯«ç§’ä½œä¸º ttlï¼ˆTime-To-Liveï¼‰, v4 ç‰ˆæœ¬ä½¿ç”¨çš„ å•ä½æ˜¯ ç§’ï¼Œä¸ºäº†ä¸å®˜æ–¹æ–‡æ¡£ä¿å­˜ä¸€è‡´ æˆ‘ä»¬ä½¿ç”¨v4ç‰ˆæœ¬ï¼Œå½“ç„¶ä½¿ç”¨v5 ä¹Ÿå¯ä»¥çš„ ï¼Œåªä¸è¿‡éœ€è¦è‡ªå·±å»å®ç°ä¸€äº›æ–¹æ³• å·¥ä½œæ•ˆç‡ä¹Ÿè®¸ ä¸å¦‚ç›´æ¥ä½¿ç”¨v4ç‰ˆæœ¬

```shell
$ yarn add cache-manager
$ yarn add  @types/cache-manager -D
$ yarn add  cache-manager-redis-store

# redis çš„docker å®‰è£…ç®€å•æŒ‡å—
$ docker pull redis:latest    
$ docker run -itd --name redis-test -p 6379:6379 redis
```

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„

```ts
// æ³¨å…¥module
@Module({
  imports: [CacheModuleNest.register({
      ttl: 5, //ç§’ é»˜è®¤è¿‡æœŸæ—¶é—´
      max: 10, //ç¼“å­˜ä¸­æœ€å¤§å’Œæœ€å°æ•°é‡
  })],
  ++++
// ä½¿ç”¨API 
import { CACHE_MANAGER, Controller, Get, Inject } from '@nestjs/common';
import { Cache } from 'cache-manager';

@Controller('cache')
export class CacheController {
  constructor(@Inject(CACHE_MANAGER) private cacheManger: Cache) {}

  @Get('t1')
  async test1() {
    // ç®€å•çš„ä½¿ç”¨å°±æ˜¯è¿™æ ·ç”¨çš„ï¼Œé»˜è®¤ç¼“å­˜è¿‡æœŸæ˜¯ 5s
    const cacheValue = await this.cacheManger.get('key1');

    if (cacheValue) {
      console.log('cacheValue', cacheValue);

      return cacheValue;
    }

    const value = Math.floor(Math.random() * 10);
    await this.cacheManger.set('key1', value);
    // å¯ä»¥è®¾ç½®è¿‡æœŸæ—¶é—´ è‹¥=0 æ°¸ä¸è¿‡æœŸ

    return value;
  }
}
```

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Cahceæä¾›çš„ interceprot å®ç°å…¨å±€çš„ ç¼“å­˜
æ³¨æ„å…¨å±€çš„ç¼“å­˜ ä»…å¯¹ getæ–¹æ³•æœ‰æ•ˆ,(æ³¨æ„ é»˜è®¤å…¨å±€é…ç½®çš„è¯ ä½¿ç”¨ URL å¹¶ä¸å…¨req RUL è€Œæ˜¯å®ƒçš„è·¯å¾„ æ¯”å¦‚ '/cache/t1' ä½œä¸ºkey)

```ts
// åº”ç”¨åœ¨æŸä¸€ä¸ª controller ä¸Š 
@Controller('cache')
@UseInterceptors(CacheInterceptor)
export class CacheController {
}

// ç›´æ¥åº”ç”¨åœ¨å…¨å±€ä¸Š (AppModule)
@Module({
  imports: [CacheModule.register()],
  controllers: [AppController],
  providers: [
    {
      provide: APP_INTERCEPTOR,
      useClass: CacheInterceptor,
    },
  ],
})
export class AppModule {}

// ä½†æ˜¯æˆ‘ åˆéœ€è¦å…¨å±€ åˆéœ€è¦è‡ªå®šä¹‰ å‘¢ï¼Ÿ
// å¯¹äºå¾®æœåŠ¡ æˆ–è€…grpc åŒæ ·é€‚ç”¨ ï¼ˆä½†æ˜¯æ³¨æ„ å¿…é¡»åŠ  key CacheKeyï¼ŒæŒ‡å®šä¸€ä¸ªç”¨äºä¾æ¬¡å­˜å‚¨å¹¶è·å–ç¼“å­˜æ•°æ®çš„é”®ï¼Œæ°¸è¿œä¹Ÿä¸è¦å»ç¼“å­˜é‚£äº›ç”¨äºå®ç°ä¸šåŠ¡é€»è¾‘ä¹Ÿä¸æ˜¯ç®€å•åœ°æŸ¥è¯¢æ•°æ®çš„è¡Œä¸ºã€‚
  @CacheKey('custom_key')
  @CacheTTL(20)
  findAll(): string[] {
    return [];
  }
```

å…³äºè‡ªå®šä¹‰åˆ° redis ä¸­å» ï¼ˆå½“ç„¶ä¸æ­¢redis ï¼Œå…¶å®ƒçš„å½“ç„¶ä¹Ÿå¯ä»¥
<https://github.com/node-cache-manager/node-cache-manager#store-engines>

```ts
// å¾ˆç®€å•....
import * as redisStore from 'cache-manager-redis-store';

@Module({
  imports: [
    CacheModuleNest.register({
      store: redisStore,
      host: 'localhost',
      port: 6379,
    }),
  ],
  controllers: [CacheController],
  providers: [],
})
export class CacheModule {}
```

å½“ç„¶Nest å…è®¸ ä½ è‡ªå·±å»å®šä¹‰ keyçš„è¿½è¸ªæ–¹å¼ ï¼Œåªéœ€è¦å®ç°å®ƒï¼Œç„¶åå¤å†™å®ƒå°±å¥½äº†, ï¼ˆJavaå³è§†æ„Ÿ)

```ts
// æ¯”å¦‚ æˆ‘å¦‚æœæƒ³è¦åˆ«çš„ä¸œè¥¿ å»è‡ªå®šä¹‰ key å°±å¯ä»¥è¿™æ ·å†™
@Injectable()
class HttpCacheInterceptor extends CacheInterceptor {
  trackBy(context: ExecutionContext): string | undefined {
    return 'key';
  }
}

```

## åºåˆ—åŒ–é—®é¢˜
>
> è¿™ä¸ªå¾ˆç®€å• ä»…ä»…æ˜¯ â€œåœ¨è¿”å›æ•°æ®çš„å‡ºå»çš„æ—¶å€™ ä»dto/entity/schema ä¸­æ’å‡ºæŸäº›å­—æ®µ/ä¿®æ”¹è¿”å›çš„è§„åˆ™ï¼Œä½†æ˜¯è¿˜å¯ä»¥ä¿æŒç±»å‹éªŒè¯ä¸æŠ¥é”™â€

```ts
// 1. å®šä¹‰ Entity ------------
import { Exclude, Expose, Transform } from 'class-transformer';

export class RoleEntity {
  id: number;
  name: string;

  constructor(partial: Partial<RoleEntity>) {
    Object.assign(this, partial);
  }
}

// æ¯”å¦‚è¿™æ ·çš„å®ä½“
export class UserEntity {
  id: number;
  firstName: string;
  lastName: string;
  _pid: number;

  // æ’å‡ºæŸä¸ª
  @Exclude()
  password: string;

  // ä¿®æ”¹åˆ«å  class çš„get å’Œset æ–¹æ³• éå¸¸åŸºç¡€çš„jsçŸ¥è¯† ä¸èµ˜è¿°
  @Expose()
  get fullName(): string {
    return `${this.firstName} ${this.lastName}`;
  }

  // å¦‚æœä½ éœ€è¦ è¿”å›å…¶ä¸­çš„ æŸä¸ª è€Œä¸æ˜¯æ•´ä¸ªobject å¯ä»¥ä½¿ç”¨
  @Transform(({ value }) => value.name)
  role: RoleEntity;

  // å¦‚æœä½  éœ€è¦ä½¿ç”¨ æ·±å…¥åˆ°åº•å±‚ è¯·ä¿®æ”¹
  // ä¼ é€’çš„é€‰é¡¹ä½œä¸ºåº•å±‚ classToPlain() å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬è‡ªåŠ¨æ’é™¤äº†æ‰€æœ‰ä»¥_å‰ç¼€å¼€å¤´çš„å±æ€§ã€‚
  // è¯¦ç»†è§  serialization.controller @SerializeOptions æ–¹æ³•

  constructor(partial: Partial<UserEntity>) {
    Object.assign(this, partial);
  }
}


// 2. ä½¿ç”¨è§„åˆ™ ------------

@Controller('serialization')
export class SerializationController {
  // ä¸å»ºè®® å…¨å±€ä½¿ç”¨ å› ä¸ºæœ‰å¯èƒ½ä¼šå­˜åœ¨é—®é¢˜ é™¤éä½ ä»”ç»†è¯„ä¼°ä¹‹å ç¡®å®å¯ä»¥å…¨å±€
  @SerializeOptions({
    excludePrefixes: ['_'], // _ å¼€å¤´çš„å±æ€§ å…¨æ’å‡º
  })
  @UseInterceptors(ClassSerializerInterceptor)
  @Get('t1')
  getT1() {
    // åªè¦è¿™ä¸ªè¿”å›çš„data ç±»èƒ½å¤Ÿåœ¨ ClassSerializerInterceptor ä¸­ åå°„å‡ºclass å°±å¯ä»¥æ­£ç¡®è§£æå’Œå¤„ç†é€»è¾‘
    return {
      users: [
        new UserEntity({
          firstName: 'Joney',
          lastName: 'SLI',
          password: 'password',
          _pid: 0,
          role: new RoleEntity({
            id: 1,
            name: 'admin',
          }),
        }),
        new UserEntity({
          firstName: 'Joney',
          lastName: 'SLI',
          password: 'password',
          _pid: 0,
          role: new RoleEntity({
            id: 1,
            name: 'admin',
          }),
        }),
      ],
    };
  }
}

```

ä½†... å®é™…çš„è¿ç”¨ä¸­å´å¹¶ä¸æ˜¯è¿™æ ·ï¼Œnestæä¾›çš„ interceptor ä¸å¤Ÿçµæ´» æ¯”å¦‚ç”¨åœ¨æˆ‘ä»¬å‰é¢çš„mongoä¸Š å°±gï¼Œ æˆ–è€…æˆ‘ä»¬æœ‰æ›´å¤æ‚çš„ typeOrm entity æ¯”å¦‚å„ç§å…³è” ä¹Ÿä¼šgï¼Œæ•…æˆ‘ä»¬éœ€è¦æ”¹é€ 

åŸç†ï¼šè¯· å‚ç…§ ClassSerializerInterceptor è‡ªå®šä¹‰ï¼Œï¼ˆ Interceptor çš„åŸºç¡€å’Œé«˜é˜¶ç”¨æ³•ï¼Œæˆ‘éƒ½è¯¦ç»†çš„ä»‹ç»è¿‡ï¼Œæ‰€ä»¥è®²é“ç† ä½ åº”è¯¥ä¼šå“ˆï¼‰

```ts
// åœ¨cat.schema.ts å®šä¹‰ä¸­ æ·»åŠ  entity
export class CatEntity {
  _id: ObjectId;
  name: string;
  age: number;
  tags: string[];
  sex: string;
  details: Record<string, any>;
  @Exclude()
  breed: string;

  @Expose()
  get id(): string {
    return this._id.toString();
  }

  constructor(partial: Partial<CatEntity>) {
    Object.assign(this, partial);
  }
}

// å®šä¹‰ä¸€ä¸ªè£…é¥°å™¨ æŠŠ CatEntity æŒ‚ä¸Šå»ï¼ˆä¸ºä»€ä¹ˆè¦è¿™æ ·åšï¼Œå› ä¸º mongoose è¿”å›çš„æ˜¯model ï¼Œ
// åŸClassSerializerInterceptor æ— æ³•æ”¾å°„å‡ºæ­£ç¡®çš„ class å’Œè£…é¥°å™¨ é™„åŠ çš„å†…å®¹

import { SetMetadata } from '@nestjs/common';

export const MONGO_ENTITY_CLASS = 'MongoEntityClass';
export const MongoEntityClass = (entity: any) =>
  SetMetadata(MONGO_ENTITY_CLASS, entity);


// extends å¹¶é‡å†™å…¶ä¸­çš„éƒ¨åˆ†æ–¹æ³• ClassSerializerInterceptor
import {
  CallHandler,
  ClassSerializerInterceptor,
  ExecutionContext,
  Injectable,
  PlainLiteralObject,
} from '@nestjs/common';
import { isArray } from 'class-validator';
import {} from 'class-transformer';
import { TransformerPackage } from '@nestjs/common/interfaces/external/transformer-package.interface';
import { loadPackage } from '@nestjs/common/utils/load-package.util';
import { Observable, map } from 'rxjs';
import { MONGO_ENTITY_CLASS } from '../decorator/MongoEntity.decorator';

/**
mongodb query å‡ºæ¥çš„æ˜¯ä¸€ä¸ªmodel è€Œä¸æ˜¯ ä¸€ä¸ªå¯ä»¥è¢« Serializer è§£æçš„ class
æ•…æˆ‘ä»¬æ·»åŠ è½¬åŒ–é…ç½® 
 (1. æ·»åŠ è£…é¥°å™¨æŒ‡å®š entityï¼Œ
 (2. æ·»åŠ  æ–°çš„ Interceptor ç»§æ‰¿ ClassSerializerInterceptor å¹¶ä¸”é‡å†™é‡Œé¢çš„æ–¹æ³•
 */

@Injectable()
export class ClassSerializerMongoModelInterceptor extends ClassSerializerInterceptor {
  transform(MongoEntity, data) {
    return Array.isArray(data)
      ? data.map((obj) => new MongoEntity(obj.toObject()))
      : new MongoEntity(data.toObject());
  }

  // é‡å†™è¿™ä¸ªæ–¹æ³•
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    const MongoEntity = this.reflector?.getAllAndOverride(MONGO_ENTITY_CLASS, [
      context.getHandler(),
      context.getClass(),
    ]);

    const contextOptions = this.getContextOptions(context);
    const options = {
      ...this.defaultOptions,
      ...contextOptions,
    };

    return next.handle().pipe(
      map((data) => {
        return this.transform(MongoEntity, data);
      }),
      map((res: PlainLiteralObject | Array<PlainLiteralObject>) => {
        return this.serialize(res, options);
      }),
    );
  }
}

// ä½¿ç”¨
@Controller('cat')
@SerializeOptions({
  excludePrefixes: ['__v', '_id'],
})
@UseInterceptors(ClassSerializerMongoModelInterceptor)
export class CatController {
  constructor(private readonly catService: CatService) {}

  @Post('create')
  create(@Body() body: any) {
    return this.catService.create(body);
  }

  @MongoEntityClass(CatEntity)
  // @UseInterceptors(ClassSerializerMongoModelInterceptor)
  // æˆ–è€…ä¸¢åˆ°å…¨å±€å»
  @Get('cat')
  async getCat(): Promise<Array<Cat>> {
    const value = await this.catService.getCat();
    log(value);
    return value;
  }
}

```

å½“ç„¶å¦‚æœä½ è§‰å¾— åŠ ä¸€ä¸ªè£…é¥°å™¨è¿‡äºéº»çƒ¦æˆ‘ä»¬è¿˜å¯ä»¥ åœ¨toObject çš„æ—¶å€™ å¤å†™ schema ç„¶åè‡ªå®šä¹‰è£…é¥°å™¨çš„ æŠŠå®ƒè½¬å‡ºæ¥

```ts
@Schema({
  autoIndex: true,
  toObject: {
    transform: (doc, ret, options) => {
      const value = new CatEntity(doc.toJSON());
      Object.setPrototypeOf(ret, Object.getPrototypeOf(value));
      return ret;
    },
  },
})
export class Cat extends Document {}

// è¿™æ ·ä½ å°±ä¸éœ€è¦å† ç”¨ @MongoEntityClass äº† ï¼Œå…·ä½“ç”¨é‚£ä¸ªæ–¹å¼ å–å†³ä½ è‡ªå·±çš„çˆ±å¥½

@Injectable()
export class ClassSerializerMongoModel2Interceptor extends ClassSerializerInterceptor {
  // æ‰©å±•ä¸€ä¸ªæ–¹æ³•
  transform(data) {
    return Array.isArray(data)
      ? data.map((obj) => obj.toObject())
      : data.toObject();
  }

  // é‡å†™è¿™ä¸ªæ–¹æ³•
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    const contextOptions = this.getContextOptions(context);
    const options = {
      ...this.defaultOptions,
      ...contextOptions,
    };
    return next.handle().pipe(
      map((data) => {
        return classToPlain(this.transform(data));
      }),
      map((res: PlainLiteralObject | Array<PlainLiteralObject>) => {
        return this.serialize(res, options);
      }),
    );
  }
}

// è¿™æ ·ç”¨çš„æ—¶å€™ å°± ä¸éœ€é¢å¤–åŠ ä¸€ä¸ª decorator äº†
@Controller('cat')
@SerializeOptions({
  excludePrefixes: ['__v', '_id'],
})
@UseInterceptors(ClassSerializerMongoModel2Interceptor)
export class CatController {
  constructor(private readonly catService: CatService) {}

  @Post('create')
  create(@Body() body: any) {
    return this.catService.create(body);
  }

  // @MongoEntityClass(CatEntity)
  // @UseInterceptors(ClassSerializerMongoModelInterceptor)
  // æˆ–è€…ä¸¢åˆ°å…¨å±€å»
  @Get('cat')
  async getCat(): Promise<Array<Cat>> {
    const value = await this.catService.getCat();
    log(value);
    return value;
  }
}

```

**å°ç»“ä¸€ä¸‹ï¼Œå®é™…çš„å·¥ä½œç»éªŒä¸­ï¼Œæˆ‘ä»¬å¾€å¾€ä¸ä¼šè¿”å› entity ä¹Ÿä¸ä¼šåœ¨ä¸Šé¢åŠ å¾ˆå¤šä¸œè¥¿ï¼Œè£…é¥°å™¨Serializer ä»€ä¹ˆçš„ï¼Œæˆ‘ä»¬æ›´å–œæ¬¢è‡ªå®šä¹‰ä¸€ä¸ª æ–°çš„class å»åš Serializer å› ä¸ºè¿™æ›´åŠ çš„è‡ªç”±**

## é˜Ÿåˆ—é—®é¢˜
>
> é˜Ÿåˆ—æ˜¯ä¸€ç§æœ‰ç”¨çš„è®¾è®¡æ¨¡å¼ï¼Œå¯ä»¥å¸®åŠ©ä½ å¤„ç†ä¸€èˆ¬åº”ç”¨è§„æ¨¡å’Œæ€§èƒ½çš„æŒ‘æˆ˜ æ¯”å¦‚ä¸‹é¢çš„ä¸€äº›åœºæ™¯ ä½ å°±ç”¨å¾—ä¸Šäº†  <a href="https://docs.nestjs.com/techniques/queues">å®˜æ–¹å‚è€ƒæ–‡æ¡£</a>

1. å¹³æ»‘è¾“å‡ºå³°å€¼
2. å µå¡è¡Œçš„ä»»åŠ¡æ‰“ç¢
3. ä¸åŒæœåŠ¡è§çš„ é€šä¿¡ï¼ˆæ¯”å¦‚æœåŠ¡å‘ç°...

å®‰è£…å¿…è¦çš„ä¾èµ–

```shell
yarn add @nestjs/bull bull 
yarn add @types/bull -D

```

```ts
// æˆ‘ä»¬éœ€è¦å…ˆæ³¨å†Œ

// ç„¶åå»æ¨¡å—ä¸­å£°æ˜æˆ‘ä»¬çš„é˜Ÿåˆ—å
// è¦ç”¨å¥½é˜Ÿåˆ—æˆ‘ä»¬éœ€è¦ç†è§£ä¸€äº›åŸºç¡€æ¦‚å¿µ
// 1. é˜Ÿåˆ— å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªç»„/group
// 2. ç”Ÿäº§è€… ä»»åŠ¡ç”Ÿäº§è€…æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—ä¸­
// 3. æ¶ˆè´¹è€… æ¶ˆè´¹è€…æ¶ˆè´¹ç”Ÿäº§è€…å‘å¸ƒçš„ä»»åŠ¡
// 4. ç›‘å¬è€… ç›‘å¬æŸä¸ªé˜Ÿåˆ—ä¸­çš„ æŸä¸ªä»»åŠ¡çš„çŠ¶æ€/æ³¨æ„å¤šçº¿ç¨‹çš„é—®é¢˜


```

å„é¡¹æ–‡æ¡£ å’Œå‚æ•°è¯´æ˜

## äº‹ä»¶

## å‹ç¼©

## æµå¤„ç†æ–‡ä»¶

## Session

## MVC

## æ€§èƒ½(Fastify)

## Serviceç«¯çš„äº‹ä»¶å‘é€

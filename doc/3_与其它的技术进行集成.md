# ä¸å…¶å®ƒçš„æŠ€æœ¯è¿›è¡Œé›†æˆ
>
> ä¸å…¶å®ƒçš„æŠ€æœ¯è¿›è¡Œé›†æˆ , æ¯”å¦‚æ•°æ®åº“ã€é…ç½®ã€éªŒè¯ã€é«˜æ•°ç¼“å­˜ã€åºåˆ—åŒ–ã€Jobã€logã€cookieã€äº‹ä»¶ã€æ–‡ä»¶ä¸Šä¼ .....

## æ•°æ®åº“é›†æˆ( Mysql + Mongo )
>
> ç”±äºå‰é¢çš„ ä¸€æœŸ å·²ç»ç®€çº¦çš„è¯´æ˜äº† è¿™é‡Œå°±ä¸å†å¦å†™äº†ï¼Œæˆ‘ä»¬åªè¡¥å……æ²¡æœ‰è¯´æ˜çš„åœ°æ–¹

### Mysql
>
> mysql ç›¸å…³çš„å†…å®¹ æˆ‘å†ä»¥å‰ä¸€æœŸçš„æ–‡ç« æœ‰è¯¦ç»†çš„è¯´æ˜ï¼Œè¯·ç§»æ­¥åˆ°è¿™é‡Œ <a>ä¸€æœŸæ–‡ç« </a>

### MongoDB
>
> ä»é›¶å¼€å§‹ é›†æˆ

ä¸€äº›åŸºç¡€çš„mongodb æŠ€æœ¯ï¼Œæˆ‘ä¹‹å‰çš„æ–‡ç« ä¹Ÿæœ‰è¯¦ç»†çš„æåˆ°ï¼Œè¯·å‚è§ <a href="https://juejin.cn/post/7104641797514592293">Nodejs + MongoDB </a>

1. ä½¿ç”¨ docker éƒ¨ç½² mongodb <a href="https://hub.docker.com/_/mongo/">Mongo</a>

```shell
$ docker pull mongo
$ docker run -itd --name mongo -p 27017:27017 mongo --auth
$ docker exec -it mongo
# è¿›å…¥è¿™ä¸ª å®¹å™¨ é‡Œé¢
$  mongosh 
# æ³¨æ„æ˜¯mongosh ä¸å†æ˜¯mongo  https://www.mongodb.com/docs/manual/release-notes/6.0-compatibility/#legacy-mongo-shell-removed

# åˆ›å»ºä¸€ä¸ªåä¸º adminï¼Œå¯†ç ä¸º 123456 çš„ç”¨æˆ·ã€‚
> db.createUser({ user:'admin',pwd:'123456',roles:[ { role:'userAdminAnyDatabase', db: 'admin'},"readWriteAnyDatabase"]});
# å°è¯•ä½¿ç”¨ä¸Šé¢åˆ›å»ºçš„ç”¨æˆ·ä¿¡æ¯è¿›è¡Œè¿æ¥ã€‚
> db.auth('admin', '123456')

```

2. å¼€å§‹é›†æˆ

å…ˆæ¥å®‰è£…å¿…è¦çš„ä¾èµ–

```shell
yarn add  @nestjs/mongoose mongoose
```

å»ºç«‹è¿æ¥

```ts
// æˆ‘è‡ªå·±æ–°å»ºäº†ä¸€ä¸ª core module æ ¸å¿ƒçš„åŠŸèƒ½é€»è¾‘éƒ½å¯ä»¥ä¸¢è¿™é‡Œæ¥
import { Module } from '@nestjs/common';
import { MongooseModule } from '@nestjs/mongoose';
@Module({
  imports: [
    MongooseModule.forRoot('mongodb://admin:123456@127.0.0.1:27017/testDB', {
      useUnifiedTopology: true,
      useNewUrlParser: true,
      authSource: 'admin',
    }),
  ],
  controllers: [], 
  providers: [],
})
export class CoreModule {}

```

åˆ›å»ºæ¨¡å‹

```ts
// å»ºè®®æ–‡ä»¶å¤¹æ”¾åˆ° module ç›¸å…³æ€§çš„æ–‡ä»¶å¤¹ä¸‹
import { Prop, Schema, SchemaFactory, raw } from '@nestjs/mongoose';
import { Document } from 'mongoose';

// å£°æ˜ document ç±»å‹
export type CatDocument = Cat & Document;

// å®šä¹‰ è¿™ä¸ªschema class
// @Schema()  å½“ç„¶ä½ å¯ä»¥ä½¿ç”¨ DefinitionsFactory æ¥ç”Ÿäº§ä¸€ä¸ªæ›´åŸå§‹çš„ schema

// @Schema ä¼šæŠŠ cat æ˜ å°„åˆ° åŒåçš„ cat å¤æ•° Collection ä¸­å»
// æ³¨æ„è¿™ä¸ª @Schema  å¯ä»¥æ¥å—æ›´å¤šçš„å‚æ•° ï¼ˆhttps://mongoosejs.com/docs/guide.html#optionsï¼‰
@Schema({
  autoIndex: true,
})
export class Cat extends Document {
  // @Props éå¸¸å¼ºå¤§ ä¸ä»…å¯ä»¥ å®šä¹‰ç±»å‹ ä¹Ÿå¯ä»¥å®šä¹‰éªŒè¯è§„åˆ™ï¼Œè¯¦ç»†ç¨³å®š  https://mongoosejs.com/docs/schematypes.html
  @Prop()
  name: string;

  @Prop()
  age: number;

  @Prop()
  breed: string;

  @Prop([String])
  tags: string[];

  @Prop({ required: true })
  sex: string;

  @Prop(
    raw({
      firstName: { type: String },
      lastName: { type: String },
    }),
  )
  details: Record<string, any>;
}

export const CatSchema = SchemaFactory.createForClass(Cat);

// å¦‚æœä¸ä¹ æƒ¯ä½¿ç”¨è£…é¥°å™¨ å¯ä»¥ ç›´æ¥ monogose
// import * as mongoose from 'mongoose';
// export const CatSchema = new mongoose.Schema({
//   name: String,
//   age: Number,
//   breed: String,
// });

```

ç‰¹åˆ«æé†’ ä½ find æˆ–è€… exec ä¸‹æ¥éƒ½æ˜¯ ä¸€ä¸ªmodel ç±»å‹æ¥è‡ªmongooseï¼Œ ç”¨å®ƒå¯ä»¥å®Œæˆå„ç§å…³è”æˆ–è€…èšåˆæŸ¥è¯¢, è¿™é‡Œä¸å¤šè¯´äº† è¯¦è§æˆ‘çš„å¦ä¸€æ–‡ç«  (<https://juejin.cn/post/7104641797514592293>)

ä½¿ç”¨

```ts
// module
import { Module } from '@nestjs/common';
import { MongooseModule } from '@nestjs/mongoose';

import { CatController } from './cat.controller';
import { CatService } from './cat.service';
import { Cat, CatSchema } from './schemas/cat.schema';

@Module({
  imports: [
    MongooseModule.forFeature(
      [
        {
          name: Cat.name,
          schema: CatSchema,
        },
      ],
    ),
  ],
  controllers: [CatController],
  providers: [CatService],
})
export class CatModule {}


// service
import { Injectable } from '@nestjs/common';
import { InjectConnection, InjectModel } from '@nestjs/mongoose';
import { Connection, Model } from 'mongoose';
import { Cat, CatDocument } from './schemas/cat.schema';

@Injectable()
export class CatService {
  // æ³¨å…¥model / è¿æ¥æ± ï¼ˆåè€…çš„åŠŸèƒ½è¦æ›´å¼ºå¤§ (https://mongoosejs.com/docs/api/connection.html#Connection())
  constructor(
    @InjectModel('Cat') private catModel: Model<CatDocument>,
    @InjectConnection() private connection: Connection,
  ) {}

  getHello(): string {
    return 'Hello World!';
  }

  async create(data: any): Promise<Cat> {
    const createCat = new this.catModel(data);
    return createCat.save();
  }
}

@Controller('cat')
export class CatController {
  constructor(private readonly catService: CatService) {}

  @Post('create')
  create(@Body() body: any) {
    return this.catService.create(body);
  }
}

```

å…¶ä»–çš„é«˜çº§æ“ä½œ

```ts
// å¦‚æœéœ€è¦ å¤šæ•°æ®åº“è¿æ¥è¯·ä½¿ç”¨
// core
  imports: [
    MongooseModule.forRoot('mongodb://admin:123456@127.0.0.1:27017/testDB', {
      useUnifiedTopology: true,
      useNewUrlParser: true,
      authSource: 'admin',
      connectionName: 'testDB',
    }),
    MongooseModule.forRoot('mongodb://admin:123456@127.0.0.1:27017/testDB2', {
      useUnifiedTopology: true,
      useNewUrlParser: true,
      authSource: 'admin',
      connectionName: 'testDB2',
    }),
  ],

// module
imports: [
    MongooseModule.forFeature(
      [
        {
          name: Cat.name,
          schema: CatSchema,
        },
      ],
      'testDB',
    ),
    MongooseModule.forFeature(
      [
        {
          name: Cat.name,
          schema: CatSchema,
        },
      ],
      'testDB2',
    ),
  ],

  // service
  @Injectable()
export class CatService {
  constructor(
    @InjectModel('Cat', 'testDB2') private catModel: Model<CatDocument>,
  ) {}

  getHello(): string {
    return 'Hello World!';
  }

  async create(data: any): Promise<Cat> {
    const createCat = new this.catModel(data);
    return createCat.save();
  }
}

```

mongoDB ä¸­é—´ä»¶ å’Œ plugin çš„ä½¿ç”¨

```ts
// é—´ä»¶æ˜¯é’ˆå¯¹Schemaå±‚çº§çš„ ï¼ˆhttps://mongoosejs.com/docs/middleware.htmlï¼‰

 MongooseModule.forFeatureAsync([
      {
        name: 'Cat',
        useFactory: () => {
          const schema = CatsSchema;
          // äº†è§£ mongoose çš„æœ‹å‹éƒ½çŸ¥é“ è¿™ä¸ªåŸºæœ¬ä¸Šå°±ä¸Šmongoose çš„åŸºæ“
          schema.pre('save', () => console.log('Hello from pre save'));
          return schema;
        },
      },
    ]),

// ç±»ä¼¼çš„ plugin ä¹Ÿæ˜¯å¦‚æ­¤ https://mongoosejs.com/docs/plugins.html

// core 
// è¦å‘æ‰€æœ‰ schema ä¸­ç«‹å³æ³¨å†Œä¸€ä¸ªæ’ä»¶ï¼Œè°ƒç”¨Connectionå¯¹è±¡ä¸­çš„.plugin()æ–¹æ³•ã€‚ä½ å¯ä»¥åœ¨æ‰€æœ‰æ¨¡å‹åˆ›å»ºå‰è®¿é—®è¿æ¥ã€‚ä½¿ç”¨connectionFactoryæ¥å®ç°ï¼š
MongooseModule.forRoot('mongodb://localhost/test', {
      connectionFactory: (connection) => {
        connection.plugin(require('mongoose-autopopulate'));
        return connection;
      },
    }),

// module
// ä»…å¯¹ æŸä¸ªscheme
   MongooseModule.forFeatureAsync([
      {
        name: 'Cat',
        useFactory: () => {
          const schema = CatsSchema;
          schema.plugin(require('mongoose-autopopulate'));
          return schema;
        },
      },
    ]),
  ],
```

å¯¹äºæµ‹è¯•ï¼ˆå•å…ƒæµ‹è¯•ä»€ä¹ˆçš„
**ä¸€èˆ¬è€Œè¨€æˆ‘ä»¬é€šå¸¸å¸Œæœ›é¿å…ä»»ä½•æ•°æ®åº“è¿æ¥**

è§£å†³æ–¹æ¡ˆæ˜¯åˆ›å»ºæ¨¡æ‹Ÿmodel

```ts
@Module({
  providers: [
    CatsService,
    {
      provide: getModelToken('Cat'), // getModelToken @nestjs/mongoose å®ƒè¿”å›ä¸€ä¸ª ç¡¬ç¼–ç  å®ä¾‹å¯¹è±¡
      useValue: catModel,
    },
  ],
})
export class CatsModule {}

```

å¯¹äºæ•°æ®çš„å…³è”æ“ä½œï¼Œè¯·ç›´æ¥å‚è€ƒ <a href="https://juejin.cn/post/7104641797514592293">è¿™é‡Œ</a> ç¨³å®š

## é…ç½®
>
> ä¸€æœŸæœ‰è¯¦ç»†çš„æè¿° ä¸åšè¿‡å¤šèµ˜è¿°

## éªŒè¯
>
> æˆ‘ä»¬è®²ä¸€ä¸‹ç»†èŠ‚é—®é¢˜ å®é™…ä¸Š æˆ‘ä»¬çš„ validation å’Œ pipç´§å¯†ç›¸å…³ï¼Œä¸ä»…ä»…æ˜¯ éªŒè¯è¿˜å¯ä»¥åšè½¬æ¢

Nest ä¼šå†…ç½® 9 ä¸ªå¼€ç®±å³ç”¨ çš„pip,å®ƒä»¬åˆ†ä¸¤ç±»

- ValidationPipe
- DefaultValuePipe
- ParseIntPipe
- ParseFloatPipe
- ParseBoolPipe
- ParseArrayPipe
- ParseUUIDPipe
- ParseEnumPipe
- ParseFilePipe

### Parse* ç±»å‹çš„Pip
>
> è¿™é‡Œçš„éƒ½æ˜¯ Parse å¼€å¤´çš„ pip ä¸»è¦ç”¨æ¥éªŒè¯ å€¼æ˜¯å¦åˆæ³•, ä½¿ç”¨éå¸¸çš„ç®€å•

```ts
import {
  Controller,
  Get,
  HttpStatus,
  Param,
  ParseIntPipe,
  Query,
} from '@nestjs/common';
@Controller('pip')
export class PipController {
  @Get('t1/:id')
  test1(@Param('id', ParseIntPipe) id: number) {
    // å‚æ•°çº§åˆ«ç»‘å®š
    return 't1';
  }

  @Get('t2/:id')
  test2(
    @Param(
      'id',
      new ParseIntPipe({ errorHttpStatusCode: HttpStatus.NOT_ACCEPTABLE }),
    )
    id: number,
  ) {
    // ä½¿ç”¨å®ä¾‹ è€Œä¸æ˜¯class classä¼šåœ¨ioc å®¹å™¨å†…éƒ¨å¤„ç†æ‰
    return 't2';
  }

  @Get('t3')
  test3(@Query('id', ParseIntPipe) id: number) {
    return 'te';
  }
}
```

### Validationç±»å‹çš„Pip
>
> å®é™…ä¸Šä¸Šè¿°çš„ 9ä¸ª åªæœ‰ä¸¤ä¸ªæ˜¯ç‰¹ä¾‹ ValidationPipe + DefaultValuePipe

è¦ä½¿ç”¨ nestå†…ç½®çš„ ValidationPipe éœ€è¦install ä¸¤ä¸ªä¾èµ–, å®ƒçš„åŠŸèƒ½éå¸¸çš„å¼ºå¤§

```shell
yarn add class-validator class-transformer
```

æœ€å¸¸è§çš„ä½¿ç”¨æ–¹å¼ å…¨å±€è‡ªåŠ¨åŠ ä¸Š ValidationPipeï¼Œç„¶åç»“åˆ class-validator æä¾›çš„è£…é¥°å™¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥éå¸¸å¿«æ·çš„å†™å‡º å¼ºå¤§ä¸”åˆé€‚çš„ pip

new ValidationPipe æœ‰è®¸å¤šå¯é€‰å‚æ•°
|name|types|des|
|------|------|-----|
| enableDebugMessages | boolean | å¦‚æœè®¾ç½®ä¸º true ï¼ŒéªŒè¯å™¨ä¼šåœ¨å‡ºé—®é¢˜çš„æ—¶å€™æ‰“å°é¢å¤–çš„è­¦å‘Šä¿¡æ¯ |
| skipUndefinedProperties | boolean | å¦‚æœè®¾ç½®ä¸º true ï¼ŒéªŒè¯å™¨å°†è·³è¿‡å¯¹æ‰€æœ‰éªŒè¯å¯¹è±¡ä¸­å€¼ä¸º null çš„å±æ€§çš„éªŒè¯ |
| skipNullProperties | boolean | å¦‚æœè®¾ç½®ä¸º true ï¼ŒéªŒè¯å™¨å°†è·³è¿‡å¯¹æ‰€æœ‰éªŒè¯å¯¹è±¡ä¸­å€¼ä¸º null æˆ– undefined çš„å±æ€§çš„éªŒè¯ |
| skipMissingProperties | boolean | å¦‚æœè®¾ç½®ä¸º true ï¼ŒéªŒè¯å™¨å°†è·³è¿‡å¯¹æ‰€æœ‰éªŒè¯å¯¹è±¡ä¸­ç¼ºå¤±çš„å±æ€§çš„éªŒè¯ |
| whitelist | boolean | å¦‚æœè®¾ç½®ä¸º true ï¼ŒéªŒè¯å™¨å°†å»æ‰æ²¡æœ‰ä½¿ç”¨ä»»ä½•éªŒè¯è£…é¥°å™¨çš„å±æ€§çš„éªŒè¯ï¼ˆè¿”å›çš„ï¼‰å¯¹è±¡ |
| forbidNonWhitelisted | boolean | å¦‚æœè®¾ç½®ä¸º true ï¼ŒéªŒè¯å™¨ä¸ä¼šå»æ‰éç™½åå•çš„å±æ€§ï¼Œè€Œæ˜¯ä¼šæŠ›å‡ºå¼‚å¸¸ |
| forbidUnknownValues | boolean | å¦‚æœè®¾ç½®ä¸º true ï¼Œå°è¯•éªŒè¯æœªçŸ¥å¯¹è±¡ä¼šç«‹å³å¤±è´¥ |
| disableErrorMessage | boolean | å¦‚æœè®¾ç½®ä¸º true ,éªŒè¯é”™è¯¯ä¸ä¼šè¿”å›ç»™å®¢æˆ·ç«¯ |
| errorHttpStatusCode | number | è¿™ä¸ªè®¾ç½®å…è®¸ä½ ç¡®å®šåœ¨é”™è¯¯æ—¶ä½¿ç”¨å“ªä¸ªå¼‚å¸¸ç±»å‹ã€‚é»˜è®¤æŠ›å‡º BadRequestException |
| exceptionFactory | Function | æ¥å—ä¸€ä¸ªéªŒè¯é”™è¯¯æ•°ç»„å¹¶è¿”å›ä¸€ä¸ªè¦æŠ›å‡ºçš„å¼‚å¸¸å¯¹è±¡ |
| groups | string[] | éªŒè¯å¯¹è±¡æ—¶ä½¿ç”¨çš„åˆ†ç»„ |
| always | boolean | è®¾ç½®è£…é¥°å™¨é€‰é¡¹ always çš„é»˜è®¤å€¼ã€‚é»˜è®¤å€¼å¯ä»¥åœ¨è£…é¥°å™¨çš„é€‰é¡¹ä¸­è¢«è¦†å†™ |
| strictGroups | boolean | å¿½ç•¥åœ¨ä»»ä½•åˆ†ç»„å†…çš„è£…é¥°å™¨ï¼Œå¦‚æœ groups æ²¡æœ‰ç»™å‡ºæˆ–è€…ä¸ºç©º |
| dismissDefaultMessages | boolean | å¦‚æœè®¾ç½®ä¸º true ï¼Œå°†ä¸ä¼šä½¿ç”¨é»˜è®¤æ¶ˆæ¯éªŒè¯ï¼Œå¦‚æœä¸è®¾ç½®ï¼Œé”™è¯¯æ¶ˆæ¯ä¼šå§‹ç»ˆæ˜¯ undefined |
| validationError.target | boolean | ç¡®å®šç›®æ ‡æ˜¯å¦è¦åœ¨ ValidationError ä¸­æš´éœ²å‡ºæ¥ |
| validationError.value | boolean | ç¡®å®šéªŒè¯å€¼æ˜¯å¦è¦åœ¨ ValidationError ä¸­æš´éœ²å‡ºæ¥ |
| stopAtFirstError | boolean | å¦‚æœè®¾ç½®ä¸º true ï¼Œå¯¹äºç»™å®šçš„å±æ€§çš„éªŒè¯ä¼šåœ¨è§¦å‘ç¬¬ä¸€ä¸ªé”™è¯¯ä¹‹ååœæ­¢ã€‚é»˜è®¤ä¸º false |

1. ç®€å•å®ç”¨

```ts
// å½“ç„¶æˆ‘ä»¬å¯ä»¥å…¨å±€å¼€ ä¹Ÿå¯ä»¥ å±€é™äº controller / å…·ä½“é¢è·¯ç”±ä¸Š
app.useGlobalPipes(new ValidationPipe());

// ä¾‹å­ğŸŒ° 
@Post()
@UsePipes(new ValidationPipe())
async create(@Body() createCatDto: CreateCatDto) {
  this.catsService.create(createCatDto);
}

// æ–°å»ºDTO
import { IsEmail, IsNotEmpty } from 'class-validator';

export class TestDto {
  @IsEmail()
  email: string;

  @IsNotEmpty()
  password: string;
}

// æ³¨æ„ä¸è¦åˆ°å¤„ type TestDto
// tsç±»å‹ä¼šåœ¨è¿è¡Œæ—¶è¢«æ“¦é™¤ï¼Œè®°å¾—ç”¨ import { CreateUserDto } è€Œä¸æ˜¯ import type { CreateUserDto }

// ä½¿ç”¨DTO
  @Post('t4')
  test4(@Body() testDto: TestDto) {
    return 't4';
  }

```

2. æ§åˆ¶ç™½åå•

```ts

// å¦‚æœä½ éœ€è¦ä½¿ç”¨ç™½åå• å¯ä»¥è¿™æ ·æ“ä½œ
app.useGlobalPipes(
  new ValidationPipe({
    whitelist: true,
    // forbidNonWhitelisted:true è‹¥ä½ å¸Œæœ› é‡åˆ°ç™½åå•çš„æ—¶å€™ è¿”å›é”™è¯¯ è¯·å¼€å¯å®ƒ
  })
);

// åœ¨DTO ä¸­ä¸åŠ ä»»ä½• è£…é¥°çš„ å°±æ˜¯ç™½åå•çš„å­—æ®µ
export class TestDto {
  @IsEmail()
  email: string;

  @IsNotEmpty()
  password: string;

  name: string
}

```

3. è¿›è¡Œè½¬æ¢

> æ³¨æ„ paser* å¼€å¤´çš„ä¼šè‡ªåŠ¨è½¬åŒ–

```ts
findOne(
  @Param('id', ParseIntPipe) id: number,
  @Query('sort', ParseBoolPipe) sort: boolean,
) {
  console.log(typeof id === 'number'); // true
  console.log(typeof sort === 'boolean'); // true
  return 'This action returns a user';
}

// æˆ‘ä»¬ç»å¸¸æœ‰è¿™æ ·çš„éœ€æ±‚ï¼šcreate çš„æ—¶å€™å¸Œæœ›ä¼ é€’å…¨éƒ¨ï¼Œmodifyçš„æ—¶å€™éœ€è¦å¤šä¼ ä¸€ä¸ª idï¼Œæœ‰æ²¡æœ‰åŠæ³•æ–¹ä¾¿çš„å®ç°å‘¢ï¼Ÿæˆ–è€…ä¿®æ”¹çš„æ—¶å€™æŸä¸ªå­—æ®µåˆå˜æˆå¯é€‰çš„äº†

// Nest æä¾›äº† PartialType() å‡½æ•°æ¥è®©è¿™ä¸ªä»»åŠ¡å˜å¾—ç®€å•
export class CreateCatDto {
  name: string;
  age: number;
  breed: string;
}

// PartialType() å‡½æ•°æ˜¯ä» @nestjs/mapped-types ä¸‹é¢çš„ä¾‹å­ æ‰€æœ‰çš„å‚æ•°éƒ½æ˜¯å¯é€‰çš„
export class UpdateCatDto extends PartialType(CreateCatDto) {}

// å¦‚æœä½ å¯¹ ts ç†Ÿæ‚‰çš„è¯ï¼ŒPickTã€Omit...... æˆ‘å°±ä¸å¤šä»‹ç»äº†è¯·çœ‹ä¸‹é¢çš„ä»£ç 
export class CreateCatDto {
  name: string;
  breed: string;
}
export class AdditionalCatInfo {
  color: string;
}
export class UpdateCatDto extends IntersectionType(
  CreateCatDto,
  AdditionalCatInfo,
) {}

// è‹¥è¦éªŒè¯Array ä¸‹é¢è¿™ç§äº‹ä¸è¡Œçš„ è¯·ä½¿ç”¨
@Post()
createBulk(@Body() createUserDtos: CreateUserDto[]) {
  return 'This action adds new users';
}

@Post()
createBulk(
  @Body(new ParseArrayPipe({ items: CreateUserDto }))
  createUserDtos: CreateUserDto[],
) {
  return 'This action adds new users';
}

// å¦‚æœä½ éœ€è¦æ‰‹åŠ¨å¤„ç† array æ¯”å¦‚ GET /?ids=1,2,3
@Get()
findByIds(
  @Query('id', new ParseArrayPipe({ items: Number, separator: ',' }))
  ids: number[],
) {
  return 'This action returns users by ids';
}


// æ›´å¤šçš„ è¯·çœ‹å®˜æ–¹æ–‡æ¡£ https://docs.nestjs.com/techniques/validation



```

### è‡ªå®šä¹‰Pip
>
> å®é™…ä¸Šçš„ ä¹Ÿå°±æ˜¯ ä¸€ä¸ª åŠŸèƒ½å¯è‡ªå®šä¹‰çš„ validation

```ts
import { PipeTransform, Injectable, ArgumentMetadata } from '@nestjs/common';
// import { ValidationPipe } from '@nestjs/common';

@Injectable()
export class MyValidationPipe implements PipeTransform {
  // å¿…é¡»è¦å®ç°çš„ä¸€ä¸ªæ–¹æ³•
  transform(value: any, metadata: ArgumentMetadata) {
    // è¿™é‡Œå¯ä»¥è¿›è¡Œè½¬åŒ– / threw error

    // Value å°±ç®—è¾“å…¥çš„value
    // metadata æ˜¯æ‰€è°“çš„ å…ƒæ•°æ® ã€‚æ¯”å¦‚string isRequired è¿™ç§

    // å…·ä½“çš„å®ç° å¯ä»¥å‚è€ƒ ValidationPipe çš„æºç å®ç°
    return value;
  }
}

```

## ç¼“å­˜é—®é¢˜
>
> Nest æä¾›äº†ä¸€ä¸ª éå¸¸å¿«æ· ä¸”ä¸éœ€è¦ å…¶å®ƒåŸºç¡€è®¾æ–½(redis ä¹‹ç±»çš„ ç¼“å­˜å·¥å…·)

æ³¨æ„ å†å²ç‰ˆæœ¬é—®é¢˜  v5 çš„ cache-manager ä½¿ç”¨ æ¯«ç§’ä½œä¸º ttlï¼ˆTime-To-Liveï¼‰, v4 ç‰ˆæœ¬ä½¿ç”¨çš„ å•ä½æ˜¯ ç§’ï¼Œä¸ºäº†ä¸å®˜æ–¹æ–‡æ¡£ä¿å­˜ä¸€è‡´ æˆ‘ä»¬ä½¿ç”¨v4ç‰ˆæœ¬ï¼Œå½“ç„¶ä½¿ç”¨v5 ä¹Ÿå¯ä»¥çš„ ï¼Œåªä¸è¿‡éœ€è¦è‡ªå·±å»å®ç°ä¸€äº›æ–¹æ³• å·¥ä½œæ•ˆç‡ä¹Ÿè®¸ ä¸å¦‚ç›´æ¥ä½¿ç”¨v4ç‰ˆæœ¬

```shell
$ yarn add cache-manager
$ yarn add  @types/cache-manager -D
$ yarn add  cache-manager-redis-store

# redis çš„docker å®‰è£…ç®€å•æŒ‡å—
$ docker pull redis:latest    
$ docker run -itd --name redis-test -p 6379:6379 redis
```

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„

```ts
// æ³¨å…¥module
@Module({
  imports: [CacheModuleNest.register({
      ttl: 5, //ç§’ é»˜è®¤è¿‡æœŸæ—¶é—´
      max: 10, //ç¼“å­˜ä¸­æœ€å¤§å’Œæœ€å°æ•°é‡
  })],
  ++++
// ä½¿ç”¨API 
import { CACHE_MANAGER, Controller, Get, Inject } from '@nestjs/common';
import { Cache } from 'cache-manager';

@Controller('cache')
export class CacheController {
  constructor(@Inject(CACHE_MANAGER) private cacheManger: Cache) {}

  @Get('t1')
  async test1() {
    // ç®€å•çš„ä½¿ç”¨å°±æ˜¯è¿™æ ·ç”¨çš„ï¼Œé»˜è®¤ç¼“å­˜è¿‡æœŸæ˜¯ 5s
    const cacheValue = await this.cacheManger.get('key1');

    if (cacheValue) {
      console.log('cacheValue', cacheValue);

      return cacheValue;
    }

    const value = Math.floor(Math.random() * 10);
    await this.cacheManger.set('key1', value);
    // å¯ä»¥è®¾ç½®è¿‡æœŸæ—¶é—´ è‹¥=0 æ°¸ä¸è¿‡æœŸ

    return value;
  }
}
```

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Cahceæä¾›çš„ interceprot å®ç°å…¨å±€çš„ ç¼“å­˜
æ³¨æ„å…¨å±€çš„ç¼“å­˜ ä»…å¯¹ getæ–¹æ³•æœ‰æ•ˆ,(æ³¨æ„ é»˜è®¤å…¨å±€é…ç½®çš„è¯ ä½¿ç”¨ URL å¹¶ä¸å…¨req RUL è€Œæ˜¯å®ƒçš„è·¯å¾„ æ¯”å¦‚ '/cache/t1' ä½œä¸ºkey)

```ts
// åº”ç”¨åœ¨æŸä¸€ä¸ª controller ä¸Š 
@Controller('cache')
@UseInterceptors(CacheInterceptor)
export class CacheController {
}

// ç›´æ¥åº”ç”¨åœ¨å…¨å±€ä¸Š (AppModule)
@Module({
  imports: [CacheModule.register()],
  controllers: [AppController],
  providers: [
    {
      provide: APP_INTERCEPTOR,
      useClass: CacheInterceptor,
    },
  ],
})
export class AppModule {}

// ä½†æ˜¯æˆ‘ åˆéœ€è¦å…¨å±€ åˆéœ€è¦è‡ªå®šä¹‰ å‘¢ï¼Ÿ
// å¯¹äºå¾®æœåŠ¡ æˆ–è€…grpc åŒæ ·é€‚ç”¨ ï¼ˆä½†æ˜¯æ³¨æ„ å¿…é¡»åŠ  key CacheKeyï¼ŒæŒ‡å®šä¸€ä¸ªç”¨äºä¾æ¬¡å­˜å‚¨å¹¶è·å–ç¼“å­˜æ•°æ®çš„é”®ï¼Œæ°¸è¿œä¹Ÿä¸è¦å»ç¼“å­˜é‚£äº›ç”¨äºå®ç°ä¸šåŠ¡é€»è¾‘ä¹Ÿä¸æ˜¯ç®€å•åœ°æŸ¥è¯¢æ•°æ®çš„è¡Œä¸ºã€‚
  @CacheKey('custom_key')
  @CacheTTL(20)
  findAll(): string[] {
    return [];
  }
```

å…³äºè‡ªå®šä¹‰åˆ° redis ä¸­å» ï¼ˆå½“ç„¶ä¸æ­¢redis ï¼Œå…¶å®ƒçš„å½“ç„¶ä¹Ÿå¯ä»¥
<https://github.com/node-cache-manager/node-cache-manager#store-engines>

```ts
// å¾ˆç®€å•....
import * as redisStore from 'cache-manager-redis-store';

@Module({
  imports: [
    CacheModuleNest.register({
      store: redisStore,
      host: 'localhost',
      port: 6379,
    }),
  ],
  controllers: [CacheController],
  providers: [],
})
export class CacheModule {}
```

å½“ç„¶Nest å…è®¸ ä½ è‡ªå·±å»å®šä¹‰ keyçš„è¿½è¸ªæ–¹å¼ ï¼Œåªéœ€è¦å®ç°å®ƒï¼Œç„¶åå¤å†™å®ƒå°±å¥½äº†, ï¼ˆJavaå³è§†æ„Ÿ)

```ts
// æ¯”å¦‚ æˆ‘å¦‚æœæƒ³è¦åˆ«çš„ä¸œè¥¿ å»è‡ªå®šä¹‰ key å°±å¯ä»¥è¿™æ ·å†™
@Injectable()
class HttpCacheInterceptor extends CacheInterceptor {
  trackBy(context: ExecutionContext): string | undefined {
    return 'key';
  }
}

```

## åºåˆ—åŒ–é—®é¢˜
>
> è¿™ä¸ªå¾ˆç®€å• ä»…ä»…æ˜¯ â€œåœ¨è¿”å›æ•°æ®çš„å‡ºå»çš„æ—¶å€™ ä»dto/entity/schema ä¸­æ’å‡ºæŸäº›å­—æ®µ/ä¿®æ”¹è¿”å›çš„è§„åˆ™ï¼Œä½†æ˜¯è¿˜å¯ä»¥ä¿æŒç±»å‹éªŒè¯ä¸æŠ¥é”™â€

```ts
// 1. å®šä¹‰ Entity ------------
import { Exclude, Expose, Transform } from 'class-transformer';

export class RoleEntity {
  id: number;
  name: string;

  constructor(partial: Partial<RoleEntity>) {
    Object.assign(this, partial);
  }
}

// æ¯”å¦‚è¿™æ ·çš„å®ä½“
export class UserEntity {
  id: number;
  firstName: string;
  lastName: string;
  _pid: number;

  // æ’å‡ºæŸä¸ª
  @Exclude()
  password: string;

  // ä¿®æ”¹åˆ«å  class çš„get å’Œset æ–¹æ³• éå¸¸åŸºç¡€çš„jsçŸ¥è¯† ä¸èµ˜è¿°
  @Expose()
  get fullName(): string {
    return `${this.firstName} ${this.lastName}`;
  }

  // å¦‚æœä½ éœ€è¦ è¿”å›å…¶ä¸­çš„ æŸä¸ª è€Œä¸æ˜¯æ•´ä¸ªobject å¯ä»¥ä½¿ç”¨
  @Transform(({ value }) => value.name)
  role: RoleEntity;

  // å¦‚æœä½  éœ€è¦ä½¿ç”¨ æ·±å…¥åˆ°åº•å±‚ è¯·ä¿®æ”¹
  // ä¼ é€’çš„é€‰é¡¹ä½œä¸ºåº•å±‚ classToPlain() å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬è‡ªåŠ¨æ’é™¤äº†æ‰€æœ‰ä»¥_å‰ç¼€å¼€å¤´çš„å±æ€§ã€‚
  // è¯¦ç»†è§  serialization.controller @SerializeOptions æ–¹æ³•

  constructor(partial: Partial<UserEntity>) {
    Object.assign(this, partial);
  }
}


// 2. ä½¿ç”¨è§„åˆ™ ------------

@Controller('serialization')
export class SerializationController {
  // ä¸å»ºè®® å…¨å±€ä½¿ç”¨ å› ä¸ºæœ‰å¯èƒ½ä¼šå­˜åœ¨é—®é¢˜ é™¤éä½ ä»”ç»†è¯„ä¼°ä¹‹å ç¡®å®å¯ä»¥å…¨å±€
  @SerializeOptions({
    excludePrefixes: ['_'], // _ å¼€å¤´çš„å±æ€§ å…¨æ’å‡º
  })
  @UseInterceptors(ClassSerializerInterceptor)
  @Get('t1')
  getT1() {
    // åªè¦è¿™ä¸ªè¿”å›çš„data ç±»èƒ½å¤Ÿåœ¨ ClassSerializerInterceptor ä¸­ åå°„å‡ºclass å°±å¯ä»¥æ­£ç¡®è§£æå’Œå¤„ç†é€»è¾‘
    return {
      users: [
        new UserEntity({
          firstName: 'Joney',
          lastName: 'SLI',
          password: 'password',
          _pid: 0,
          role: new RoleEntity({
            id: 1,
            name: 'admin',
          }),
        }),
        new UserEntity({
          firstName: 'Joney',
          lastName: 'SLI',
          password: 'password',
          _pid: 0,
          role: new RoleEntity({
            id: 1,
            name: 'admin',
          }),
        }),
      ],
    };
  }
}

```

ä½†... å®é™…çš„è¿ç”¨ä¸­å´å¹¶ä¸æ˜¯è¿™æ ·ï¼Œnestæä¾›çš„ interceptor ä¸å¤Ÿçµæ´» æ¯”å¦‚ç”¨åœ¨æˆ‘ä»¬å‰é¢çš„mongoä¸Š å°±gï¼Œ æˆ–è€…æˆ‘ä»¬æœ‰æ›´å¤æ‚çš„ typeOrm entity æ¯”å¦‚å„ç§å…³è” ä¹Ÿä¼šgï¼Œæ•…æˆ‘ä»¬éœ€è¦æ”¹é€ 

åŸç†ï¼šè¯· å‚ç…§ ClassSerializerInterceptor è‡ªå®šä¹‰ï¼Œï¼ˆ Interceptor çš„åŸºç¡€å’Œé«˜é˜¶ç”¨æ³•ï¼Œæˆ‘éƒ½è¯¦ç»†çš„ä»‹ç»è¿‡ï¼Œæ‰€ä»¥è®²é“ç† ä½ åº”è¯¥ä¼šå“ˆï¼‰

```ts
// åœ¨cat.schema.ts å®šä¹‰ä¸­ æ·»åŠ  entity
export class CatEntity {
  _id: ObjectId;
  name: string;
  age: number;
  tags: string[];
  sex: string;
  details: Record<string, any>;
  @Exclude()
  breed: string;

  @Expose()
  get id(): string {
    return this._id.toString();
  }

  constructor(partial: Partial<CatEntity>) {
    Object.assign(this, partial);
  }
}

// å®šä¹‰ä¸€ä¸ªè£…é¥°å™¨ æŠŠ CatEntity æŒ‚ä¸Šå»ï¼ˆä¸ºä»€ä¹ˆè¦è¿™æ ·åšï¼Œå› ä¸º mongoose è¿”å›çš„æ˜¯model ï¼Œ
// åŸClassSerializerInterceptor æ— æ³•æ”¾å°„å‡ºæ­£ç¡®çš„ class å’Œè£…é¥°å™¨ é™„åŠ çš„å†…å®¹

import { SetMetadata } from '@nestjs/common';

export const MONGO_ENTITY_CLASS = 'MongoEntityClass';
export const MongoEntityClass = (entity: any) =>
  SetMetadata(MONGO_ENTITY_CLASS, entity);


// extends å¹¶é‡å†™å…¶ä¸­çš„éƒ¨åˆ†æ–¹æ³• ClassSerializerInterceptor
import {
  CallHandler,
  ClassSerializerInterceptor,
  ExecutionContext,
  Injectable,
  PlainLiteralObject,
} from '@nestjs/common';
import { isArray } from 'class-validator';
import {} from 'class-transformer';
import { TransformerPackage } from '@nestjs/common/interfaces/external/transformer-package.interface';
import { loadPackage } from '@nestjs/common/utils/load-package.util';
import { Observable, map } from 'rxjs';
import { MONGO_ENTITY_CLASS } from '../decorator/MongoEntity.decorator';

/**
mongodb query å‡ºæ¥çš„æ˜¯ä¸€ä¸ªmodel è€Œä¸æ˜¯ ä¸€ä¸ªå¯ä»¥è¢« Serializer è§£æçš„ class
æ•…æˆ‘ä»¬æ·»åŠ è½¬åŒ–é…ç½® 
 (1. æ·»åŠ è£…é¥°å™¨æŒ‡å®š entityï¼Œ
 (2. æ·»åŠ  æ–°çš„ Interceptor ç»§æ‰¿ ClassSerializerInterceptor å¹¶ä¸”é‡å†™é‡Œé¢çš„æ–¹æ³•
 */

@Injectable()
export class ClassSerializerMongoModelInterceptor extends ClassSerializerInterceptor {
  transform(MongoEntity, data) {
    return Array.isArray(data)
      ? data.map((obj) => new MongoEntity(obj.toObject()))
      : new MongoEntity(data.toObject());
  }

  // é‡å†™è¿™ä¸ªæ–¹æ³•
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    const MongoEntity = this.reflector?.getAllAndOverride(MONGO_ENTITY_CLASS, [
      context.getHandler(),
      context.getClass(),
    ]);

    const contextOptions = this.getContextOptions(context);
    const options = {
      ...this.defaultOptions,
      ...contextOptions,
    };

    return next.handle().pipe(
      map((data) => {
        return this.transform(MongoEntity, data);
      }),
      map((res: PlainLiteralObject | Array<PlainLiteralObject>) => {
        return this.serialize(res, options);
      }),
    );
  }
}

// ä½¿ç”¨
@Controller('cat')
@SerializeOptions({
  excludePrefixes: ['__v', '_id'],
})
@UseInterceptors(ClassSerializerMongoModelInterceptor)
export class CatController {
  constructor(private readonly catService: CatService) {}

  @Post('create')
  create(@Body() body: any) {
    return this.catService.create(body);
  }

  @MongoEntityClass(CatEntity)
  // @UseInterceptors(ClassSerializerMongoModelInterceptor)
  // æˆ–è€…ä¸¢åˆ°å…¨å±€å»
  @Get('cat')
  async getCat(): Promise<Array<Cat>> {
    const value = await this.catService.getCat();
    log(value);
    return value;
  }
}

```

å½“ç„¶å¦‚æœä½ è§‰å¾— åŠ ä¸€ä¸ªè£…é¥°å™¨è¿‡äºéº»çƒ¦æˆ‘ä»¬è¿˜å¯ä»¥ åœ¨toObject çš„æ—¶å€™ å¤å†™ schema ç„¶åè‡ªå®šä¹‰è£…é¥°å™¨çš„ æŠŠå®ƒè½¬å‡ºæ¥

```ts
@Schema({
  autoIndex: true,
  toObject: {
    transform: (doc, ret, options) => {
      const value = new CatEntity(doc.toJSON());
      Object.setPrototypeOf(ret, Object.getPrototypeOf(value));
      return ret;
    },
  },
})
export class Cat extends Document {}

// è¿™æ ·ä½ å°±ä¸éœ€è¦å† ç”¨ @MongoEntityClass äº† ï¼Œå…·ä½“ç”¨é‚£ä¸ªæ–¹å¼ å–å†³ä½ è‡ªå·±çš„çˆ±å¥½

@Injectable()
export class ClassSerializerMongoModel2Interceptor extends ClassSerializerInterceptor {
  // æ‰©å±•ä¸€ä¸ªæ–¹æ³•
  transform(data) {
    return Array.isArray(data)
      ? data.map((obj) => obj.toObject())
      : data.toObject();
  }

  // é‡å†™è¿™ä¸ªæ–¹æ³•
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    const contextOptions = this.getContextOptions(context);
    const options = {
      ...this.defaultOptions,
      ...contextOptions,
    };
    return next.handle().pipe(
      map((data) => {
        return classToPlain(this.transform(data));
      }),
      map((res: PlainLiteralObject | Array<PlainLiteralObject>) => {
        return this.serialize(res, options);
      }),
    );
  }
}

// è¿™æ ·ç”¨çš„æ—¶å€™ å°± ä¸éœ€é¢å¤–åŠ ä¸€ä¸ª decorator äº†
@Controller('cat')
@SerializeOptions({
  excludePrefixes: ['__v', '_id'],
})
@UseInterceptors(ClassSerializerMongoModel2Interceptor)
export class CatController {
  constructor(private readonly catService: CatService) {}

  @Post('create')
  create(@Body() body: any) {
    return this.catService.create(body);
  }

  // @MongoEntityClass(CatEntity)
  // @UseInterceptors(ClassSerializerMongoModelInterceptor)
  // æˆ–è€…ä¸¢åˆ°å…¨å±€å»
  @Get('cat')
  async getCat(): Promise<Array<Cat>> {
    const value = await this.catService.getCat();
    log(value);
    return value;
  }
}

```

**å°ç»“ä¸€ä¸‹ï¼Œå®é™…çš„å·¥ä½œç»éªŒä¸­ï¼Œæˆ‘ä»¬å¾€å¾€ä¸ä¼šè¿”å› entity ä¹Ÿä¸ä¼šåœ¨ä¸Šé¢åŠ å¾ˆå¤šä¸œè¥¿ï¼Œè£…é¥°å™¨Serializer ä»€ä¹ˆçš„ï¼Œæˆ‘ä»¬æ›´å–œæ¬¢è‡ªå®šä¹‰ä¸€ä¸ª æ–°çš„class å»åš Serializer å› ä¸ºè¿™æ›´åŠ çš„è‡ªç”±**

## é˜Ÿåˆ—é—®é¢˜
>
> é˜Ÿåˆ—æ˜¯ä¸€ç§æœ‰ç”¨çš„è®¾è®¡æ¨¡å¼ï¼Œå¯ä»¥å¸®åŠ©ä½ å¤„ç†ä¸€èˆ¬åº”ç”¨è§„æ¨¡å’Œæ€§èƒ½çš„æŒ‘æˆ˜ æ¯”å¦‚ä¸‹é¢çš„ä¸€äº›åœºæ™¯ ä½ å°±ç”¨å¾—ä¸Šäº†  <a href="https://docs.nestjs.com/techniques/queues">å®˜æ–¹å‚è€ƒæ–‡æ¡£</a>

1. å¹³æ»‘è¾“å‡ºå³°å€¼
2. å µå¡è¡Œçš„ä»»åŠ¡æ‰“ç¢
3. ä¸åŒæœåŠ¡è§çš„ é€šä¿¡ï¼ˆæ¯”å¦‚æœåŠ¡å‘ç°...

å®‰è£…å¿…è¦çš„ä¾èµ–

```shell
yarn add @nestjs/bull bull 
yarn add @types/bull -D
```

```ts
// æˆ‘ä»¬éœ€è¦å…ˆæ³¨å†Œ æ¨¡å—å’Œé˜Ÿåˆ—
@Module({
  imports: [
    // æ³¨å†Œé˜Ÿåˆ— åä¸ºaudio å®ƒæœ‰å¾ˆå¤šå±æ€§ï¼Œè¯·å‚è€ƒæºä»£ç ä¸­çš„ æ³¨é‡Š
    BullModule.forRoot({
      redis: {
        host: 'localhost',
        port: 6379,
      },
    }),
    BullModule.registerQueue({
      name: 'audio',
    }),
  ],
  controllers: [QueueController],
  providers: [QueueModuleService, AudioConsumer, AudioService],
})
export class QueueModule {}

// ç„¶åå»æ¨¡å—ä¸­å£°æ˜æˆ‘ä»¬çš„é˜Ÿåˆ—å
// è¦ç”¨å¥½é˜Ÿåˆ—æˆ‘ä»¬éœ€è¦ç†è§£ä¸€äº›åŸºç¡€æ¦‚å¿µ
// 1. é˜Ÿåˆ— å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªç»„/group
// 2. ç”Ÿäº§è€… ä»»åŠ¡ç”Ÿäº§è€…æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—ä¸­
// 3. æ¶ˆè´¹è€… æ¶ˆè´¹è€…æ¶ˆè´¹ç”Ÿäº§è€…å‘å¸ƒçš„ä»»åŠ¡
// 4. ç›‘å¬è€… ç›‘å¬æŸä¸ªé˜Ÿåˆ—ä¸­çš„ æŸä¸ªä»»åŠ¡çš„çŠ¶æ€/æ³¨æ„å¤šçº¿ç¨‹çš„é—®é¢˜

// å®šä¹‰ ç”Ÿäº§è€… è®¢é˜…è€… + ç›‘å¬è€…ï¼ˆä¸€èˆ¬ç›‘å¬è€… å’Œç”Ÿäº§è€…åœ¨ä¸€èµ·

// ç”Ÿäº§è€… push ä¸€ä¸ªjob åˆ°é˜Ÿåˆ—ä¸­å»
@Controller('queue')
export class QueueController {
  constructor(
    @InjectQueue('audio') private audioQueue: Queue,
    private readonly audioConsumer: AudioConsumer,
  ) {}

  // ä»»åŠ¡è¡¨ç°ä¸ºåºåˆ—åŒ–çš„JavaScriptå¯¹è±¡ï¼ˆå› ä¸ºå®ƒä»¬è¢«å­˜å‚¨åœ¨ Redis æ•°æ®åº“ä¸­ï¼‰
  async startAudioQueue() {
    // æ³¨æ„ä»»åŠ¡æœ‰è®¸å¤šå¯é€‰é¡¹é…ç½® è¯¦è§ä¸‹æ–‡æ–‡æ¡£
    const job = await this.audioQueue.add('transcode', {
      foo: 'bar',
    });

    return job;
  }

  // é˜Ÿåˆ—ç®¡ç†
  async pauseQueue() {
    await this.audioQueue.pause();
  }

  async resumeQueue() {
    await this.audioQueue.resume();
  }

    @Get('start')
  async start() {
     await this.startAudioQueue();
     return 'ok'
  }
++++
}

// AudioConsumer æ¶ˆè´¹è€…å’Œç›‘å¬è€…
import {
  Processor,
  Process,
  OnQueueActive,
  OnGlobalQueueCompleted,
  OnQueueCompleted,
} from '@nestjs/bull';
import { Job } from 'bull';

@Processor('audio')
export class AudioConsumer {
  // æ¶ˆè´¹è€…
  // åœ¨å·¥ä½œç©ºé—²æˆ–è€…é˜Ÿåˆ—ä¸­æœ‰æ¶ˆæ¯è¦å¤„ç†çš„æ—¶å€™è¢«è‡ªåŠ¨è°ƒç”¨
  @Process('transcode')
  async transcode(job: Job<unknown>) {
    // æ³¨æ„è¿™ä¸ªå‚æ•° ä»…ä½œä¸ºå‚æ•°ï¼Œå¤„ç†å®Œä¹‹åæ‰å¯ä»¥è®¿é—® ä¹Ÿå°±æ˜¯ doSomethingä¹‹å
    let progress = 0;
    for (let i = 0; i < 100; i++) {
      progress += 10;
      job.progress(progress);
      // progress ç”¨æ¥æ›´æ–° jobè¿›ç¨‹
    }
    return progress;
    // å®ƒè¿”å›ä¸€ä¸ª æ•°æ®JS object
  }

  // ç›‘å¬è€…1 Activeæ—¶ç›‘å¬ æ³¨æ„æœ‰è®¸å¤šç§ç±»å‹çš„çŠ¶æ€ç›‘å¬ è€Œä¸”è¿˜ä¼šåŒºåˆ† å…¨å±€ï¼ˆåˆ†å¸ƒå¼/ æœ¬åœ°çš„ ä¸¤ç±»
  @OnQueueActive({ name: 'transcode' })
  onActive(job: Job) {
    console.log(
      `Processing job ${job.id} of type ${job.name} with data ${job.data}...`,
    );
  }

  // ç›‘å¬è€…2 å®Œæˆæ—¶ ç›‘å¬
  @OnQueueCompleted({
    name: 'transcode',
  })
  async onQueueCompleted(jobId: number, result: any) {
    // const job = await this.que.getJob(jobId);
    await this.mockJob(6000);
    console.log('(Global) on completed: job ', jobId, ' -> result: ', result);
  }

  // ç›‘å¬è€…2 å®Œæˆæ—¶ ç›‘å¬(å…¨å±€)
  @OnGlobalQueueCompleted({
    name: 'transcode',
  })
  async onGlobalCompleted(jobId: number, result: any) {
    await this.mockJob(6000);
    console.log('(Global) on completed: job ', jobId, ' -> result: ', result);
  }

  // æµ‹è¯•æ–¹æ³• æ¨¡æ‹Ÿ å µå¡ä»»åŠ¡
  async mockJob(time: number) {
    return new Promise((resvole, reject) => {
      setTimeout(() => resvole('1'), time);
    });
  }
}

```

å„é¡¹æ–‡æ¡£ å’Œå‚æ•°è¯´æ˜

| æœ¬åœ°äº‹ä»¶ç›‘å¬è€…      | å…¨å±€äº‹ä»¶ç›‘å¬è€…            | å¤„ç†å™¨æ–¹æ³•ç­¾å/å½“è§¦å‘æ—¶                     |
| ------------------- | ------------------------- | ----------------------------------------------------------------------------------------------------------|
| @OnQueueError()     | @OnGlobalQueueError()     | handler(error: Error) - å½“é”™è¯¯å‘ç”Ÿæ—¶ï¼Œ`error`åŒ…æ‹¬è§¦å‘é”™è¯¯                                                  |
| @OnQueueWaiting()   | @OnGlobalQueueWaiting()   | handler(jobId: number \| string) - ä¸€æ—¦å·¥ä½œè€…ç©ºé—²å°±ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œ`jobId`åŒ…æ‹¬è¿›å…¥æ­¤çŠ¶æ€çš„ id |
| @OnQueueActive()    | @OnGlobalQueueActive()    | handler(job: Job)-`job`ä»»åŠ¡å·²å¯åŠ¨                                                                          |
| @OnQueueStalled()   | @OnGlobalQueueStalled()   | handler(job: Job)-`job`ä»»åŠ¡è¢«æ ‡è®°ä¸ºå»¶è¿Ÿã€‚è¿™åœ¨æ—¶é—´å¾ªç¯å´©æºƒæˆ–æš‚åœæ—¶è¿›è¡Œè°ƒè¯•å·¥ä½œæ—¶æ˜¯å¾ˆæœ‰æ•ˆçš„                  |
| @OnQueueProgress()  | @OnGlobalQueueProgress()  | handler(job: Job, progress: number)-`job`ä»»åŠ¡è¿›ç¨‹è¢«æ›´æ–°ä¸º`progress`å€¼                                      |
| @OnQueueCompleted() | @OnGlobalQueueCompleted() | handler(job: Job, result: any) `job`ä»»åŠ¡è¿›ç¨‹æˆåŠŸä»¥`result`ç»“æŸ                                             |
| @OnQueueFailed()    | @OnGlobalQueueFailed()    | handler(job: Job, err: Error)`job`ä»»åŠ¡ä»¥`err`åŸå› å¤±è´¥                                                      |
| @OnQueuePaused()    | @OnGlobalQueuePaused()    | handler()é˜Ÿåˆ—è¢«æš‚åœ                                                                                        |
| @OnQueueResumed()   | @OnGlobalQueueResumed()   | handler(job: Job)é˜Ÿåˆ—è¢«æ¢å¤                                                                                |
| @OnQueueCleaned()   | @OnGlobalQueueCleaned()   | handler(jobs: Job[], type: string) æ—§ä»»åŠ¡ä»é˜Ÿåˆ—ä¸­è¢«æ¸…ç†ï¼Œ`job`æ˜¯ä¸€ä¸ªæ¸…ç†ä»»åŠ¡æ•°ç»„ï¼Œ`type`æ˜¯è¦æ¸…ç†çš„ä»»åŠ¡ç±»å‹ |
| @OnQueueDrained()   | @OnGlobalQueueDrained()   | handler()åœ¨é˜Ÿåˆ—å¤„ç†å®Œæ‰€æœ‰ç­‰å¾…çš„ä»»åŠ¡ï¼ˆé™¤éæœ‰äº›å°šæœªå¤„ç†çš„ä»»åŠ¡è¢«å»¶è¿Ÿï¼‰æ—¶å‘å°„å‡º                                |
| @OnQueueRemoved()   | @OnGlobalQueueRemoved()   | handler(job: Job)`job`ä»»åŠ¡è¢«æˆåŠŸç§»é™¤                                                                       |

## å‹ç¼©
>
> æ³¨æ„è¿™ä¸ª ä»…ä»…æ˜¯ä¸€ä¸ª é€‚ç”¨äº webç¨‹åºçš„åº”ç”¨ï¼Œåœ¨ä¼ä¸šä¸­ å¤§å®¶æœ€å¥½ä½¿ç”¨ nginx æ¥åš è¿™ç±»çš„äº‹æƒ…ï¼Œå¦‚æœä½ ä»…ä»…æ˜¯ç®€å•ç©ç© å¯ä»¥å§è¿™ä¸ªå¼€äº†

```ts
// express å’Œ fastify è¦ç”¨ä¸ä¸€æ ·çš„åŒ… 
import * as compression from 'compression';
// somewhere in your initialization file
app.use(compression());

import * as compression from 'fastify-compress';
// somewhere in your initialization file
app.register(compression);
```

## æµå¤„ç†æ–‡ä»¶
>
> è¿™ä¸ªéœ€æ±‚  â€œä¸‹è½½æ–‡ä»¶â€

```ts
import { Controller, Get, StreamableFile, Response } from '@nestjs/common';
import { createReadStream } from 'fs';
import { join } from 'path';

@Controller('file')
export class FileController {
  @Get('t1')
  getFile(): StreamableFile {
    // è¯·ä¸è¦ä½¿ç”¨ @res è¦ä¸ç„¶ï¼Œå…¶å®ƒçš„å…¨å±€é”™è¯¯æ‹¦æˆªå™¨ å°†è¿æ¥ä¸åˆ°ä½ çš„å„ç§error
    // é‚£å°±æ˜¯ä»£ä»· è‹¥ä¸€å®šè¦ä½¿ç”¨ è¯·å¼€å¯ passthrough: true çœ‹ä¸‹é¢çš„ä¾‹å­
    // å…·ä½“æ–‡æ¡£  https://docs.nestjs.com/controllers#library-specific-approach
    const file = createReadStream(join(process.cwd(), 'package.json'));
    return new StreamableFile(file);
  }

  @Get('t2')
  getFile2(@Response({ passthrough: true }) res): StreamableFile {
    const file = createReadStream(join(process.cwd(), 'package.json'));
    res.set({
      'Content-Type': 'application/json',
      'Content-Disposition': 'attachment; filename="package.json"',
    });
    return new StreamableFile(file);
  }
}

```

## HTTP
>
> Nest å¾ˆå¤šçŸ¥è¯†ç‚¹ éƒ½å€Ÿé‰´äº† Angular æ‰€ä»¥ Rxjs å½“ç„¶æ˜¯è¦æŒæ¡çš„ è¯·çœ‹å…¶ å®˜æ–¹æ–‡æ¡£ <a href="https://rxjs.tech/">Rxjs</a>

æˆ‘ä»¬ç›´æ¥ä»¥ä¸€ä¸ª ä¾‹å­æ¥è¯´ ï¼Œæ¯”å¦‚è¯·æ±‚ä¸€ä¸ªç¬¬ä¸‰æ–¹æ¥å£  <https://api.wrdan.com/hitokoto>

```shell
yarn add  @nestjs/axios
```

```ts
//  è‹¥è¦ä½¿ç”¨ è¯·æå‰æ³¨å…¥
import { HttpModule } from '@nestjs/axios';
@Module({
  imports: [
    HttpModule.register({
      timeout: 5000, //  æœ€å¤§å…è®¸ è¶…æ—¶ 5s
      maxRedirects: 5, // å¤±è´¥ä¹‹åçš„ æœ€å¤§retry æ¬¡æ•°
    }),
  ],
  controllers: [FileController],
  providers: [],
})
export class FileModule {}


import { HttpService } from '@nestjs/axios';
import { AxiosResponse } from 'axios';
import { map, catchError } from 'rxjs/operators';
import { Observable, of } from 'rxjs';
++++
  constructor(private readonly httpService: HttpService) {}

  @Get('t3')
  testAxios(): Observable<AxiosResponse<any> | any> {
    return this.httpService.get('https://api.wrdan.com/hitokoto').pipe(
      map((data) => {
        return {
          data: data.data,
          success: true,
        };
      }),
      catchError((err) => {
        return of({
          success: false,
          data: null,
        });
      }),
    );
  }
++++
```

## Cookies & Session

å…ˆé—®å¤§å®¶ä¸€ä¸ªé¢è¯•é¢˜ Cookies & Session æœ‰è¯´æ˜åŒºåˆ«ï¼Ÿ

ç­”ï¼šsessionçš„å¸¸è§å®ç°è¦å€ŸåŠ©cookieæ¥å‘é€sessionID.è€ŒCookies æ˜¯å·²ç»å®ç°çš„API ã€‚
Sessionæ˜¯åœ¨æœåŠ¡ç«¯ä¿å­˜çš„ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œç”¨æ¥è·Ÿè¸ªç”¨æˆ·çš„çŠ¶æ€ï¼Œè¿™ä¸ªæ•°æ®å¯ä»¥ä¿å­˜åœ¨é›†ç¾¤ã€æ•°æ®åº“ã€æ–‡ä»¶ä¸­ï¼›

Cookieæ˜¯å®¢æˆ·ç«¯ä¿å­˜ç”¨æˆ·ä¿¡æ¯çš„ä¸€ç§æœºåˆ¶ï¼Œç”¨æ¥è®°å½•ç”¨æˆ·çš„ä¸€äº›ä¿¡æ¯ï¼Œä¹Ÿæ˜¯å®ç°Sessionçš„ä¸€ç§æ–¹å¼ã€‚å®ƒæ˜¯ä¸€ä¸ªå…·ä½“API

ä¸€èˆ¬çš„æˆ‘ä»¬è®¤ä¸ºï¼šSession = Cookie+å…¶å®ƒï¼Œå­˜å‚¨äºservice ä¸Š

è¯¦ç»†è¯·å‚è€ƒ <https://www.zhihu.com/question/19786827>

### Cookies
>
> Cookieçš„ä½œç”¨ æˆ‘è¿™é‡Œå°±ä¸è§£é‡Šäº† ï¼Œç›¸ä¿¡å¤§å®¶éƒ½è¯´æœ‰æ°´å¹³çš„ å¼€å‘å“ˆï¼Œç›´æ¥ä¸Šå¹²è´§ï¼Œ

è¦æƒ³åœ¨Nest è§£æ cookie éœ€è¦å®‰è£…ä¸¤ä¸ªä¾èµ–ï¼Œè€Œä¸”ä¾æ®ä¸åŒçš„å¹³å° é€‰æ‹©çš„åŒ…ä¹Ÿä¸ä¸€æ ·ï¼Œä½¿ç”¨æ–¹å¼ä¹Ÿè¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼Œå®‰è£…å®˜æ–¹æ–‡æ¡£ä¸­å°±ç”¨ Express / Fastify ä¸¤ç§åšè¯´æ˜

```shell
$yarn add @types/cookie-parser -D 
$yarn add cookie-parser
```

è¯¦ç»†çš„ä½¿ç”¨ä»‹ç»

```ts
import * as cookieParser from 'cookie-parser';
import { cookieSecret } from './modules/cookieSessionTest/cookieSession.controller';
  // string åˆ™ç›´æ¥ç”¨å»åŠ å¯† Array çš„è¯ å°è¯•ä½¿ç”¨æ¯ä¸ªä¾æ¬¡è¿›è¡Œ secret åŠ å¯†
  // è‹¥æä¾›äº†å€¼ é‚£ä¹ˆä¼šä»·åœ¨ req.signedCookies ä¸Š
  // è‹¥æ²¡æœ‰ æä¾›(ä¸åŠ å¯†) å°±åœ¨ req.cookies ä¸Š
  // app.use(cookieParser());
  app.use(cookieParser(cookieSecret));

  // ç®€å•å®ç”¨
import { Controller, Get, Req, Res } from '@nestjs/common';
import { Request, Response } from 'express';
import * as crypto from 'crypto';
import { Cookies } from './decorator/cookie.decorator';

export const cookieSecret = 'joney_';
@Controller('cookieSession')
export class CookieSessionController {
  @Get('t1')
  t1(@Req() request: Request) {
    // ç®€å•è·å–cookie
    console.log(request.cookies);
    // ä¸€èˆ¬æƒ…å†µä¸‹ä¼ä¸šçº§ä½¿ç”¨çš„æ—¶å€™ éƒ½ä¼šç»™cookie è¿›è¡ŒåŠ å¯†(éƒ¨åˆ†å†…å®¹
    console.log(request.signedCookies);
  }

  @Get('t2')
  t2(@Res({ passthrough: true }) response: Response) {
    const valueStr = JSON.stringify({
      name: 'Joney',
      age: 24,
      address: 'CD',
      baseInfo: {
        f: 1,
      },
    });
    // è‹¥ éœ€è¦ åŠ å¯†è¯·ä½¿ç”¨ signed: true
    // é»˜è®¤ä¼š å»å– mainä¸­è®¾ç½®çš„ cookieSecret æ‹¿å€¼
    // ä½†.... è¿™æœ‰ç‚¹æ‹‰èƒ¯ ä¸å»ºè®®ä½¿ç”¨ è¦ç”¨è¿˜è¯·ä½¿ç”¨
    // crypto + è‡ªå®šä¹‰ middleware å®ç°
    response.cookie('joney', valueStr, {
      signed: true,
    });
  }

  // å¦‚æœéœ€è¦ æ›´æ–¹ä¾¿çš„è·å– ä½ å¯ä»¥å®ç°ä¸€ä¸ª è£…é¥°å™¨
  @Get('t3')
  t3(@Cookies('joney') val: any) {
    console.log(val);
  }
}

// è£…é¥°å™¨
import { createParamDecorator, ExecutionContext } from '@nestjs/common';

export const Cookies = createParamDecorator(
  (data: string, ctx: ExecutionContext) => {
    const request = ctx.switchToHttp().getRequest();
    const requestVal = Object.entries(request.cookies).length
      ? request.cookies
      : request.signedCookies;
    return data ? requestVal?.[data] : requestVal;
  },
);
```

å¦‚æœä½¿ç”¨ fastify-cookie å°±ä½¿ç”¨è¿™æ ·çš„

```ts
$ yarn add  fastify-cookie

// ç»‘å®šä¸­é—´ä»¶
import fastifyCookie from 'fastify-cookie';
// somewhere in your initialization file
const app = await NestFactory.create<NestFastifyApplication>(
  AppModule,
  new FastifyAdapter(),
);
app.register(fastifyCookie, {
  secret: 'my-secret', // for cookies signature
});


// ä½¿ç”¨
@Get()
findAll(@Res({ passthrough: true }) response: FastifyReply) {
  response.setCookie('key', 'value')
}
```

### Session
>
> ç”¨æ¥å¤„ç† session æ•°æ®çš„ ğŸ”§ å·¥å…·ï¼Œä¹Ÿæœ‰ä¸¤ä¸ªç‰ˆæœ¬  express/fastify

æˆ‘ä»¬å…ˆè®²è®²express çš„

```shell
yarn add express-session
yarn add @types/express-session
```

é¦–å…ˆåœ¨å…¨å±€ä¸­æŒ‚è½½

```ts
import * as session from 'express-session';
// somewhere in your initialization file
app.use(
  session({
    // æ³¨æ„è¿™é‡Œå‚æ•°æœ‰å¾ˆå¤š è¯¦è§æ–‡æ¡£  https://github.com/expressjs/session
    secret: 'my-secret',
    saveUninitialized: false,
    // secure:true ç”Ÿäº§ç¯å¢ƒä¸‹ æˆ‘ä»¬åº”è¯¥å¼€å¯ https
  }),
);
// åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæœ‰æ„çš„é»˜è®¤ä¸åœ¨æœåŠ¡å™¨ç«¯æä¾›ä¼šè¯å­˜å‚¨ã€‚å› ä¸ºè¿™åœ¨å¾ˆå¤šåœºåˆä¸‹ä¼šé€ æˆå†…å­˜æ³„æ¼ï¼Œä¸èƒ½æ‰©å±•åˆ°å•ä¸ªè¿›ç¨‹ï¼Œå› æ­¤ä»…ç”¨äºè°ƒè¯•å’Œå¼€å‘ç¯å¢ƒã€‚å‚è§å®˜æ–¹ä»“åº“ã€‚
```

ç„¶åå°±æ˜¯è¯»å– session

```ts
@Get()
findAll(@Req() request: Request) {
  req.session.visits = req.session.visits ? req.session.visits + 1 : 1;
}

// ä½¿ç”¨èµ·æ¥ä¹Ÿç›¸å¯¹ç®€å•
@Get('t4')
t4(@Req() request: Request) {
  log(request.session);
  return 0;
}

@Get('t5')
t5(@Session() session: Record<string, any>) {
  log(session);
  return 0;
}
```

ä»¥ä¸‹æ˜¯ åŸºäº fastify å®ç°çš„

```shell
yarn add fastify-secure-session
```

```ts

import secureSession from 'fastify-secure-session';

// somewhere in your initialization file
const app = await NestFactory.create<NestFastifyApplication>(
  AppModule,
  new FastifyAdapter(),
);
app.register(secureSession, {
  secret: 'averylogphrasebiggerthanthirtytwochars',
  salt: 'mq9hDxBVDbspDR6n',
});


// ä½¿ç”¨
import * as secureSession from 'fastify-secure-session'
@Get()
findAll(@Req() request: FastifyRequest) {
  const visits = request.session.get('visits');
  request.session.set('visits', visits ? visits + 1 : 1);
}

@Get()
findAll(@Session() session: secureSession.Session) {
  const visits = session.get('visits');
  session.set('visits', visits ? visits + 1 : 1);
}
```

## MVC
>
> æ¨¡æ¿æ¸²æŸ“ï¼ˆSSR ï¼‰ Model-View-Controller

æ•¬å‘Š éƒ½2023å¹´.... è¿˜åœ¨ç”¨æ¨¡æ¿æ¸²æŸ“ æœ‰ç‚¹æ‹‰èƒ¯äº†å“ˆï¼Œè¯·å‚è€ƒ æˆ‘çš„è¿™ç¯‡æ–‡ç«  <a href="https://juejin.cn/post/7163566391881105415">ä»é›¶æ„å»ºè‡ªå·±çš„SSRåŒæ„æ¡†æ¶ï¼ˆåŒ…å«Vite + Vite-plugin-ssr + React + Nest ç­‰å†…å®¹</a>ï¼Œå®ƒç»“åˆäº†ç°ä»£åŒ–çš„ å‰ç«¯æ¡†æ¶(React) å®ç°äº†ä¸€å¥—å®Œæˆçš„ SSRåŒæ„ æ··åˆæ¸²æŸ“æ–¹æ¡ˆï¼Œä¹Ÿæ˜¯ <a href="">Newegg</a> åœ¨ç”¨çš„æ–¹æ¡ˆ

æˆ‘ä»¬ç»è¿‡å‰é¢çš„å­¦ä¹ ï¼Œç›®å‰åªéœ€è¦äº†è§£ View å¦‚ä½•å®ç°å’Œä½¿ç”¨å°±å¥½äº†, ä¸ºäº†å°½åŠ›å’Œå®˜æ–¹æ–‡æ¡£ä¿æŒä¸€è‡´ æˆ‘ä»¬ä»ç„¶ä½¿ç”¨ hbs æ¨¡æ¿å¼•æ“ï¼Œå½“ç„¶ä½ å¯ä»¥ä½¿ç”¨å…¶ä»–çš„ ï¼Œé“ç†æ˜¯ä¸€æ ·çš„

hbsæ˜¯åŸºäºhandlebarsjs ç»™ express å®ç°çš„ æ¨¡æ¿å¼•æ“ï¼Œå› æ­¤ä½ å¯ä»¥ç›´æ¥å»çœ‹ handlebarsjs çš„<a href="https://handlebarsjs.com/guide/#partials">handlebarsjsæ–‡æ¡£</a> ,è¯­æ³•ç»†èŠ‚å’Œå¤§å¤šæ•° æ¨¡æ¿å¼•æ“ ä¸€æ ·

```shell
yarn add hbs
```

å»ºç«‹static èµ„æºç›®å½•å’Œ ï¼Œtemplate æ¨¡æ¿ç›®å½•
/-public
/--js
/----home.js
/--css
/----home.css
/views
/----home.hbs
/----p1.hbs

home.js and css

```js
.home-page {
  width: 500px;
  height: 500px;
  background-color: blanchedalmond;
}

(function () {
  console.log('this is home');
})();

```

home.hbs & pa.hbs

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ title }}</title>
  <link rel="stylesheet" href="static/css/home.css">
</head>
<body>
  <h2>æˆ‘æ˜¯Home</h2>
  <div class="home-page">
  {{ message }}
  </div>
  
  <script src="static/js/home.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ title }}</title>
  <link rel="stylesheet" href="static/css/home.css">
</head>
<body>
  <h2>æˆ‘æ˜¯P1</h2>
  <div class="home-page">
  {{ message }}
  </div>
  
  <script src="static/js/home.js"></script>
</body>
</html>
```

Nestæ¡†æ¶çš„ è®¾ç½®

```ts
  // æŒ‚è½½ sessionä¸­é—´ä»¶
  app.use(
    session({
      secret: seesionSecret,
      saveUninitialized: false,
    }),
  );

  // è®¾ç½®æ¨¡æ¿æ¸²æŸ“ å’Œå‰ç«¯éœ€è¦static ç›®å½•
  // ä¸€èˆ¬çš„æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒä¸Šä¼šé‡å‘½å é™æ€è·¯å¾„, è€Œä¸”ä¼šå¦å¤–ä¸Šæ¬¡åˆ° CDN ä¸Šå»
  app.useStaticAssets(join(__dirname, '..', 'public'), {
    prefix: '/static',
  });
  app.setBaseViewsDir(join(__dirname, '..', 'views'));
  app.setViewEngine('hbs');


import { Controller, Get, Param, Query, Render, Res } from '@nestjs/common';
import { log } from 'console';
import { Response } from 'express';

@Controller('pages')
export class PageController {
  @Get()
  @Render('home')
  root() {
    return {
      title: 'Home',
      message: 'Hello world!',
    };
  }

  // åŠ¨æ€æ¸²æŸ“
  @Get('p1')
  // æ³¨æ„ ä½ ä¸èƒ½ä½¿ç”¨ passthrough: true
  p1(@Res() res: Response) {
    return res.render('p1', {
      title: 'P1',
      message: 'Hello world!',
    });
  }

  // å¤§éƒ¨åˆ†æƒ…å†µä¸‹ æˆ‘ä»¬ç”¨ä¸åˆ° åŠ¨æ€æ¸²æŸ“ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯ä¼ é€’å‚æ•°
  @Get('p2/:id')
  @Render('p1')
  p2(@Param('id') id: string) {
    log(id);
    return {
      title: id,
      message: 'Hello world!',
    };
  }
}

```

è‹¥ç”¨ fastify è¯·çœ‹

```ts
yarn add fastify point-of-view handlebars

async function bootstrap() {
  const app = await NestFactory.create<NestFastifyApplication>(AppModule, new FastifyAdapter());
  app.useStaticAssets({
    root: join(__dirname, '..', 'public'),
    prefix: '/public/',
  });
  app.setViewEngine({
    engine: {
      handlebars: require('handlebars'),
    },
    templates: join(__dirname, '..', 'views'),
  });
  await app.listen(3000);
}
bootstrap();

import { Get, Controller, Render } from '@nestjs/common';

@Controller()
export class AppController {
  @Get()
  @Render('index.hbs')
  root() {
    return { message: 'Hello world!' };
  }
}
```

## æ€§èƒ½(Fastify)
>
> æˆ‘ä»¬å‰é¢çš„ä¸€ç›´éƒ½åœ¨å¼ºè°ƒ express vs fastify ï¼Œé‚£ä¹ˆFastify åˆ°åº•ï¼Ÿ

å®é™…ä¸Šæ˜¯ä¸€ä¸ª <a href="https://www.fastify.io/">Fastify</a> nodejs æ¡†æ¶ï¼Œä¼ è¯´ä¸­æ€§èƒ½åŠæ‰“ express egg.... å½“ç„¶ä¹ŸåŠæ‰“egg

å®é™…ä¸Šæ¢èµ·æ¥ä¹Ÿç‰¹åˆ«ç®€å•

```ts
async function bootStrap2() {
  const app = await NestFactory.create<NestFastifyApplication>(
    AppModule,
    new FastifyAdapter(),
  );
  await app.listen(3000);
  // éœ€è¦æ³¨æ„çš„æ˜¯ ä¸€æ—¦ä½ æ¢ FastifyAdapter é‚£ä¹ˆå°± express ç›¸å…³çš„å°±éœ€è¦å»æ‰ æ¢æˆ Fastify é…å¥—çš„
}
bootStrap2();
```

ä½†æ˜¯ä¸å¾—è¯´ä¸€äº› å®ƒçš„ç”Ÿæ€ï¼Œæ¯”å¦‚expressçš„å„ç§å¥‡å¥‡æ€ªæ€ªçš„ä¸­é—´ä»·ï¼Œèƒ½ä¸èƒ½è¢«æ”¯æŒ(æœ‰æ²¡æœ‰å¹³æ›¿å“)...å°±... æ¬¢è¿ç”¨è¿‡çš„äººæ¥è¯„è®ºåŒº ç•™ä¸‹ä½ çš„è§‚ç‚¹

## å…³äºå®‰å…¨ğŸ”
>
> å…³äºåº”ç”¨çš„å®‰å…¨ æœ‰è®¸å¤šæ–¹é¢

### è®¤è¯ ä¸é‰´æƒ
>
> å…³äºè®¤è¯çš„ï¼Œæˆ‘ä»¬å·²ç»åœ¨ ä¹‹å‰çš„æ–‡ç« ä¸­æœ‰æåˆ°  link åœ¨è¿™é‡Œ <a href="https://juejin.cn/post/7079809024694157325#heading-11">è®¤è¯é—®é¢˜(åŸºäºJWT)</a>
> å…³äº é‰´æƒ æˆ‘ä»¬æ¥æ¢è®¨ä¸€ä¸‹

1. ä¸€ä¸ªéå¸¸ç®€å•çš„é‰´æƒ å®ç°ï¼Œè¯·å‚è€ƒæˆ‘ä¹‹å‰çš„æ–‡ç« ï¼Œåœ¨å“ªé‡Œ å®ç°äº†ä¸€ä¸ªéå¸¸ç®€æ˜“çš„ é‰´æƒGuard <a href="https://juejin.cn/post/7230012114600886309#heading-6">ç®€æ˜“çš„RBAC</a>

2. Claims-based authorization ,åŸºäºæƒé™ çš„é‰´æƒ

è¿™ä¸ªä»…ä»…æ˜¯æŠŠ æˆ‘ä»¬çš„1 ä¸­çš„æ“ä½œ æ¢äº†ä¸€ä¸‹ï¼Œ1 ä¸­æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ åŸºäºè§’è‰²çš„é‰´æƒï¼Œæ¯”å¦‚ä»€ä¹ˆè§’è‰² èƒ½æœ‰å“ªäº›æƒé™èƒ½åšä»€ä¹ˆ ä¸èƒ½åšä»€ä¹ˆï¼Œè€Œ åŸºäº æƒé™ çš„é‰´æƒï¼Œæ˜¯å¹³é“ºçš„åˆ†é…æƒé™ ç»™ç”¨æˆ· å®ƒçœ‹èµ·æ¥ä¹Ÿè®¸åº”è¯¥æ˜¯è¿™æ ·çš„ã€‚è™½ç„¶çµæ´»ï¼Œä½†æ˜¯ç»´æŠ¤å´å¹¶ä¸ç®€å•

```ts
@Post()
@RequirePermissions(Permission.CREATE_CAT)
create(@Body() createCatDto: CreateCatDto) {
  this.catsService.create(createCatDto);
}
```

3. ä¸æˆç†Ÿçš„ ç¬¬ä¸‰æ–¹package é›†æˆ æ¯”å¦‚ CASL (å½“ç„¶ä½ å¯ä»¥é€‰æ‹©ä½¿ç”¨åˆ«çš„)

æ³¨æ„ï¼šå¦‚æœç”¨äºç”Ÿäº§ è¯·ä¸€å®šä¸€å®šè¦è¯»ä¸€ä¸‹ CASL çš„å…¨æ–‡æ–‡æ¡£ <a href="https://casl.js.org/v6/en/advanced/typescript">CASL</a>

```shell
yarn add  @casl/ability
```

å…·ä½“ç»†èŠ‚ï¼ˆåŸºç¡€ä½¿ç”¨

```ts
// å…ˆæŒ‰ç…§ CASL æ–‡æ¡£ å®ç° Factory
export enum Action {
  Manage = 'manage', //å±äº CASLå…³é”®å­— è¡¨ç¤ºä»€ä¹ˆæ“ä½œéƒ½å¯ä»¥
  Create = 'create',
  Read = 'read',
  Update = 'update',
  Delete = 'delete',
}
export class Article {
  id: number;
  isPublished: boolean;
  authorId: number;

  constructor(article: Article) {
    Object.assign(this, article);
  }
}
export class User {
  id: number;
  isAdmin: boolean;

  constructor(use: User) {
    Object.assign(this, use);
  }
}

import { Injectable } from '@nestjs/common';
import { User } from './entity/user.entiry';
import {
  AbilityBuilder,
  AbilityClass,
  InferSubjects,
  Ability,
  ExtractSubjectType,
} from '@casl/ability';
import { Article } from './entity/article.entiry';
import { Action } from './type';

type Subjects = InferSubjects<typeof Article | typeof User> | 'all';
// all ä¸º CASL å…³é”®å­ï¼Œè¡¨ç¤ºä»»ä½•å¯¹è±¡

export type AppAbility = Ability<[Action, Subjects]>;

@Injectable()
export class CaslAbilityFactory {
  createForUser(user: User) {
    const { can, cannot, build } = new AbilityBuilder<
      Ability<[Action, Subjects]>
    >(Ability as AbilityClass<AppAbility>);

    if (user.isAdmin) {
      can(Action.Manage, 'all'); // read-write access to everything
    } else {
      can(Action.Read, 'all'); // read-only access to everything
    }

    can(Action.Update, Article, { authorId: user.id });
    cannot(Action.Delete, Article, { isPublished: true });

    return build({
      // Read https://casl.js.org/v5/en/guide/subject-type-detection#use-classes-as-subject-types for details
      detectSubjectType: (item) =>
        item.constructor as ExtractSubjectType<Subjects>,
    });
  }
}


// å¦‚æœè¦å…¨å±€ä½¿ç”¨ è®°å¾—åœ¨ module export å‡ºå»
import { CaslAbilityFactory } from './casAbility.factory';

@Module({
  imports: [],
  controllers: [CASLController],
  providers: [CaslAbilityFactory],
  exports: [CaslAbilityFactory],
})
export class CASLModule {}

// åŸºç¡€ä½¿ç”¨ï¼ˆAPIçš„æ–¹å¼è°ƒç”¨
@Controller('casl')
export class CASLController {
  constructor(private caslAbility: CaslAbilityFactory) {}

  // ç®€å•çš„é›†æˆåˆ°Nestä¸­ç›´æ¥ä½¿ç”¨ API
  @Get('t1')
  async t1() {
    const use = new User({
      id: 0,
      isAdmin: false,
    });
    const ability = this.caslAbility.createForUser(use);
    if (ability.can(Action.Read, 'all')) {
      log('2');
    }
  }
  +++
}
```

å¦‚æœä½ å¸Œæœ› å®šä¹‰æˆ Decorator  + Guard è¯· çœ‹ä¸‹é¢çš„å®ç°

```ts
// ~ type/index.ts
import { AppAbility } from '../casAbility.factory';

export enum Action {
  Manage = 'manage', //å±äº CASLå…³é”®å­— è¡¨ç¤ºä»€ä¹ˆæ“ä½œéƒ½å¯ä»¥
  Create = 'create',
  Read = 'read',
  Update = 'update',
  Delete = 'delete',
}

export interface IPolicyHandler {
  handle(ability: AppAbility): boolean;
}

type PolicyHandlerCallback = (ability: AppAbility) => boolean;

// è¿™ä¸ªå¤„ç†å‡½æ•°åŒæ—¶æ”¯æŒ ä½¿ç”¨ callback / Class æ¥å¤„ç† æƒé™
export type PolicyHandler = IPolicyHandler | PolicyHandlerCallback;


// ~ decorator/checkPolicies.decorator.ts
import { SetMetadata } from '@nestjs/common';
import { PolicyHandler } from '../type';

export const CHECK_POLICIES_KEY = 'check_policy';
export const CheckPolicies = (...handlers: PolicyHandler[]) =>
  SetMetadata(CHECK_POLICIES_KEY, handlers);

// ~ gourd/policies.guard.ts
import { CanActivate, ExecutionContext, Injectable } from '@nestjs/common';
import { Reflector } from '@nestjs/core';
import { AppAbility, CaslAbilityFactory } from '../casAbility.factory';
import { PolicyHandler } from '../type';
import { CHECK_POLICIES_KEY } from '../decorator/CheckPolicies.decorator';
import { User } from '../entity/user.entiry';

// å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„ gourd( å¾ˆç®€å• å¦‚æœä½ ä¸æ‡‚ï¼Œè¯·è®¤çœŸ çœ‹æˆ‘çš„æ–‡ç« https://juejin.cn/post/7230012114600886309#heading-6 )
@Injectable()
export class PoliciesGuard implements CanActivate {
  constructor(
    private reflector: Reflector,
    private caslAbilityFactory: CaslAbilityFactory,
  ) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    const policyHandlers =
      this.reflector.get<PolicyHandler[]>(
        CHECK_POLICIES_KEY,
        context.getHandler(),
      ) || [];

    // mock
    const user = new User({
      id: 0,
      isAdmin: false,
    });
    // const { user } = context.switchToHttp().getRequest();
    const ability = this.caslAbilityFactory.createForUser(user);

    return policyHandlers.every((handler) =>
      this.execPolicyHandler(handler, ability),
    );
  }

  private execPolicyHandler(handler: PolicyHandler, ability: AppAbility) {
    if (typeof handler === 'function') {
      return handler(ability);
    }
    return handler.handle(ability);
  }
}

// ï½ casl.controller.ts
++++
class ReadArticlePolicyHandler implements IPolicyHandler {
  handle(ability: AppAbility) {
    return ability.can(Action.Read, Article);
  }
}

++++
  // ä½†æ˜¯å¥½åƒä¸å¤Ÿä¼˜é›…ï¼Ÿæˆ‘ä»¬èƒ½ä¸èƒ½åšæˆ 1 ä¾‹å­ä¸­è¿™æ · RBAC è£…é¥°å™¨å‘¢ï¼Ÿå½“ç„¶å¯ä»¥ å¯ä»¥ç»“åˆ è‡ªå®šä¹‰è£…é¥°å™¨ å’Œ è‡ªå®šä¹‰Guardå®ç°
  @Get('t2')
  @UseGuards(PoliciesGuard)
  @CheckPolicies((ability: AppAbility) => ability.can(Action.Create, Article))
  t2() {
    log('éªŒè¯æˆåŠŸ');
    return 0;
  }

  // å¦‚æœç”¨ç±»è¯·ä½¿ç”¨ (ä¸æ¨è)
  @Get('t3')
  @UseGuards(PoliciesGuard)
  @CheckPolicies(new ReadArticlePolicyHandler()) // æ³¨æ„è¿™é‡Œå¿…é¡»New ä»–ä¸èƒ½ è‡ªåŠ¨æ³¨å…¥ï¼Œå¦‚æœè¦åš ä½ éœ€è¦å®ç° ModuleRef
  // æ–‡æ¡£åœ¨è¿™é‡Œ https://docs.nestjs.com/fundamentals/module-ref
  t3() {
    log('éªŒè¯æˆåŠŸ');
    return 0;
  }
```

### åŠ å¯†ğŸ”
>
> åœ¨nodejsä¸Šæœ€å¯Œæœ‰ç››å çš„å°±æ˜¯ crypto äº†è¿™é‡Œä¸è¯¦ç»†é“ºå¼€è¯´æ˜ï¼Œå› ä¸ºä¹‹å‰çš„ åšè®¤è¯çš„æ—¶å€™ä¹Ÿæœ‰æåŠ ï¼Œä¸è¯¦ç»†å±•å¼€è¯´æ˜ link åœ¨è¿™é‡Œ <a href="https://juejin.cn/post/7079809024694157325#heading-11">è®¤è¯é—®é¢˜(åŸºäºJWT)</a>

### å…¶å®ƒåº”ç”¨å®‰å…¨é˜²å¾¡æªæ–½

1. Helmet

> ç®€å•çš„æ¥è¯´è¿™æ˜¯ä¸€ä¸ªpackage åŠŸè¿‡åˆç†çš„è®¾ç½® header ä¿¡æ¯æ¥é¿å…ä¸€äº› æ¥è‡ªå¤–éƒ¨çš„æ”»å‡» ï¼Œæ–‡æ¡£è¯¦è§
> <a href="https://helmetjs.github.io/">helmetjs</a>

```ts
yarn add helmet
// ä½¿ç”¨å¾ˆç®€å• æ³¨æ„è¦åœ¨ app.useåŠ åˆ°æœ€â€œé¡¶ä¸Šâ€ ä¹Ÿå°±æ˜¯å…¶å®ƒuseä¸­é—´ä»·ä½¿ç”¨ä¹‹å‰
import helmet from 'helmet';
app.use(helmet(
  {
    // è¿™é‡Œå¯ä»¥é…ç½®ç›¸å…³çš„å‚æ•° è¯·å‚è€ƒ helmetjs æ–‡æ¡£
  }
));

// è‹¥è¯´ fastify é‚£ä¹ˆè¯·æ›¿æ¢å¯¹åº”çš„åŒ…

yarn add fastify-helmet
import * as helmet from 'fastify-helmet';
// somewhere in your initialization file
app.register(helmet);
app.register(helmet, {
  contentSecurityPolicy: {
    directives: {
      defaultSrc: [`'self'`],
      styleSrc: [`'self'`, `'unsafe-inline'`, 'cdn.jsdelivr.net', 'fonts.googleapis.com'],
      fontSrc: [`'self'`, 'fonts.gstatic.com'],
      imgSrc: [`'self'`, 'data:', 'cdn.jsdelivr.net'],
      scriptSrc: [`'self'`, `https: 'unsafe-inline'`, `cdn.jsdelivr.net`],
    },
  },
});

// If you are not going to use CSP at all, you can use this:
app.register(helmet, {
  contentSecurityPolicy: false,
});

```

2. CORS

> è·¨åŸŸé—®é¢˜ ä¸€é”®å¤„ç† è¿˜æ˜¯éå¸¸ä¸é”™çš„

```ts
// å¼€å¯æ–¹å¼1
const app = await NestFactory.create(AppModule, { cors:true });

// å¼€å¯æ–¹å¼2
// app.enableCors({
//   // éœ€è¦ä¼ é€’ä¸€äº›å‚æ•°  CORS é…ç½®å¯¹è±¡ æˆ– å›è°ƒå‡½æ•° 
//   // æ–‡æ¡£è¿™é‡Œ https://github.com/expressjs/cors#configuring-cors-asynchronously
// });

await app.listen(3000);

```

3. CSRF

> ä¸»è¦æ˜¯å¤„ç† XSF å·¥å…·ç­‰ è·¨ç«™ç«™ç‚¹è¯·æ±‚ä¼ªé€  ä¹‹ç±»çš„æ”»å‡»

```ts
// ç›´æ¥ä½¿ç”¨ csurf ä¸­é—´ä»¶
$ yarn add csurf
import * as csurf from 'csurf';
app.use(csurf());

// fastify è¯·å‚è€ƒä¸‹é¢
$ yarn add fastify-csrf
import fastifyCsrf from 'fastify-csrf';
app.register(fastifyCsrf);
```

4. é™é€Ÿ(é™æµ)

> å½“æˆ‘ä»¬é‡åˆ°è¿™æ ·çš„æ”»å‡» â€œæš´åŠ›è®¿é—® 1s 1000w æ¬¡â€ ï¼Œä¸è¿‡å¤§éƒ¨åˆ†æƒ…å†µä¸‹ æˆ‘ä»¬ä¼šæŠŠè¿™ä¸ªåŠŸèƒ½ äº¤ç»™Nginxè¿™ç±»çš„å·¥å…·å»åš
> è€Œä¸æ˜¯å†™åœ¨ç¨‹åºé‡Œ...

```ts
yarn add express-rate-limit
import rateLimit from 'express-rate-limit';
app.use(
  rateLimit({
    windowMs: 15 * 60 * 1000, // 15 minutes
    max: 100, // limit each IP to 100 requests per windowMs
  })
);

// æ³¨æ„å¦‚æœæ˜¯ fastify è¯·ç”¨  fastify-rate-limit æ›¿æ¢

// è¿˜éœ€è¦æ³¨æ„ å¦‚æœ ä½ çš„ç¨‹åº ä¸Šå±‚æœ‰åå‘ä»£ç† æ¯”å¦‚Nginx è¯·ç¡®ä¿ ç¨‹åºèƒ½è¯†åˆ«åˆ° æµé‡è¿›æ¥çš„IP
// Express å¯èƒ½éœ€è¦é…ç½®ä¸ºä¿¡ä»» proxy è®¾ç½®çš„å¤´æ–‡ä»¶ï¼Œä»è€Œä¿è¯æœ€ç»ˆç”¨æˆ·å¾—åˆ°æ­£ç¡®çš„ IP åœ°å€
const app = await NestFactory.create<NestExpressApplication>(AppModule);
// see https://expressjs.com/en/guide/behind-proxies.html
app.set('trust proxy', 1);

```
